<!DOCTYPE html><html lang="cn" dir="ltr" class="no-js" data-env="dev-env"><head><meta name="generator" content="Hexo 3.9.0"><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-SNH2MHXGCW"></script><script>window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-SNH2MHXGCW');</script><meta charset="utf-8"><meta name="renderer" content="webkit"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="author" content="Designed by 阿里云UED AX"><title>proxy_connect - The Tengine Web Server</title><meta name="description" content="该模块提供对HTTP方法CONNECT的支持。（Tengine 2.3.0版本之后）该方法主要用于SSL请求隧道。ExampleConfiguration Exampleserver &amp;#123;    listen                         3128;    # dns resolver used by forward proxying    resolver"><meta property="og:type" content="article"><meta property="og:title" content="proxy_connect"><meta property="og:url" content="http://tengine.taobao.org/document_cn/proxy_connect_cn.html"><meta property="og:site_name" content="The Tengine Web Server"><meta property="og:description" content="该模块提供对HTTP方法CONNECT的支持。（Tengine 2.3.0版本之后）该方法主要用于SSL请求隧道。ExampleConfiguration Exampleserver &amp;#123;    listen                         3128;    # dns resolver used by forward proxying    resolver"><meta property="og:locale" content="default"><meta property="og:updated_time" content="2023-11-09T13:09:23.199Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="proxy_connect"><meta name="twitter:description" content="该模块提供对HTTP方法CONNECT的支持。（Tengine 2.3.0版本之后）该方法主要用于SSL请求隧道。ExampleConfiguration Exampleserver &amp;#123;    listen                         3128;    # dns resolver used by forward proxying    resolver"><link rel="alternate" href="/atom.xml" title="The Tengine Web Server" type="application/atom+xml"><link rel="stylesheet" href="/css/base.min.css"><link rel="stylesheet" href="/css/main.css"></head><body class="page-is-loading"><div class="container-fluid"><div class="row global-header"><div class="container"><div class="row"><div class="col-lg-12"><div class="row"><div class="navbar-header col-lg-2 col-xs-12"><button aria-controls="nav-menu" aria-expanded="false" class="navbar-toggle collapsed" data-target="#nav-menu" data-toggle="collapse" type="button"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button><h1 class="text-muted site-logo navbar-brand"><a href="/" id="logo" class="text-hide">The Tengine Web Server</a></h1></div><div class="col-lg-10 col-xs-12"><nav id="nav-menu" class="navbar-collapse collapse" aria-expanded="false"><ul class="nav navbar-nav navbar-right"><li role="presentation"><a class="menu-item" href="/documentation.html">Tengine</a></li><li role="presentation"><a class="menu-item" href="/guide.html">Tengine-Ingress</a></li><li role="presentation"><a class="menu-item" href="/blog.html">Blog</a></li><li role="presentation"><a class="menu-item" href="/download.html">Download</a></li><li role="presentation"><a class="menu-item" href="/source.html">Source</a></li><li role="presentation"><a class="menu-item" href="/contact.html">Contact</a></li><li role="presentation"><a class="menu-item" href="/faq.html">FAQ</a></li><li role="presentation" class="col-hide-xs"><select class="lang-switch pull-right"></select></li><li role="presentation" class="hide"><a href="#"><i class="fa fa-bars" aria-hidden="true"></i></a></li></ul></nav></div></div></div></div></div></div></div><div class="container-fluid" id="main"><section class="row"><div class="fluid-container"><div class="container"><article id="post-document_cn/proxy_connect_cn" class="article article-type-post" itemscope itemprop="blogPost"><div class="article-inner"><header class="article-header"><h1 class="article-title" itemprop="name">proxy_connect</h1></header><div class="article-entry" itemprop="articleBody"><p>该模块提供对HTTP方法CONNECT的支持。（Tengine 2.3.0版本之后）<br>该方法主要用于<a href="https://en.wikipedia.org/wiki/HTTP_tunnel#HTTP_CONNECT_tunneling" target="_blank" rel="noopener">SSL请求隧道</a>。</p><h1 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h1><h2 id="Configuration-Example"><a href="#Configuration-Example" class="headerlink" title="Configuration Example"></a>Configuration Example</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen                         3128;</span><br><span class="line"></span><br><span class="line">    # dns resolver used by forward proxying</span><br><span class="line">    resolver                       8.8.8.8;</span><br><span class="line"></span><br><span class="line">    # forward proxy for CONNECT request</span><br><span class="line">    proxy_connect;</span><br><span class="line">    proxy_connect_allow            443 563;</span><br><span class="line">    proxy_connect_connect_timeout  10s;</span><br><span class="line">    proxy_connect_read_timeout     10s;</span><br><span class="line">    proxy_connect_send_timeout     10s;</span><br><span class="line"></span><br><span class="line">    # forward proxy for non-CONNECT request</span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://$host;</span><br><span class="line">        proxy_set_header Host $host;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Example-for-curl"><a href="#Example-for-curl" class="headerlink" title="Example for curl"></a>Example for curl</h2><p>你可以通过HTTP CONNECT隧道访问任意HTTPS网站。<br>使用命令<code>curl</code>的简单示例如下：</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ curl https://github.com/ -v -x 127.0.0.1:3128</span><br><span class="line">*   Trying 127.0.0.1...                                           -.</span><br><span class="line">* Connected to 127.0.0.1 (127.0.0.1) port 3128 (#0)                | curl与Tengine（proxy_connect模块）创建TCP连接。</span><br><span class="line">* Establish HTTP proxy tunnel to github.com:443                   -&apos;</span><br><span class="line">&gt; CONNECT github.com:443 HTTP/1.1                                 -.</span><br><span class="line">&gt; Host: github.com:443                                         (1) | curl发送CONNECT请求以创建隧道。</span><br><span class="line">&gt; User-Agent: curl/7.43.0                                          |</span><br><span class="line">&gt; Proxy-Connection: Keep-Alive                                    -&apos;</span><br><span class="line">&gt;</span><br><span class="line">&lt; HTTP/1.0 200 Connection Established                             .- Tengine返回200说明隧道建立成功。</span><br><span class="line">&lt; Proxy-agent: nginx                                           (2)|  (后续客户端发送的任何数据都会被代理到对端，Tengine不会修改任何被代理的数据）</span><br><span class="line">&lt;                                                                 &apos;-</span><br><span class="line"></span><br><span class="line">* Proxy replied OK to CONNECT request</span><br><span class="line">* TLS 1.2 connection using TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256  -.</span><br><span class="line">* Server certificate: github.com                                   |</span><br><span class="line">* Server certificate: DigiCert SHA2 Extended Validation Server CA  | curl通过隧道发送&quot;https://github.com&quot;请求，</span><br><span class="line">* Server certificate: DigiCert High Assurance EV Root CA           | proxy_connect模块将把数据代理到对端（github.com）。</span><br><span class="line">&gt; GET / HTTP/1.1                                                   |</span><br><span class="line">&gt; Host: github.com                                             (3) |</span><br><span class="line">&gt; User-Agent: curl/7.43.0                                          |</span><br><span class="line">&gt; Accept: */*                                                     -&apos;</span><br><span class="line">&gt;</span><br><span class="line">&lt; HTTP/1.1 200 OK                                                 .-</span><br><span class="line">&lt; Date: Fri, 11 Aug 2017 04:13:57 GMT                             |</span><br><span class="line">&lt; Content-Type: text/html; charset=utf-8                          |  任何来自对端的数据都会被proxy_connect模块发送给客户端curl。</span><br><span class="line">&lt; Transfer-Encoding: chunked                                      |</span><br><span class="line">&lt; Server: GitHub.com                                           (4)|</span><br><span class="line">&lt; Status: 200 OK                                                  |</span><br><span class="line">&lt; Cache-Control: no-cache                                         |</span><br><span class="line">&lt; Vary: X-PJAX                                                    |</span><br><span class="line">...                                                               |</span><br><span class="line">... &lt;other response headers &amp; response body&gt; ...                  |</span><br><span class="line">...                                                               &apos;-</span><br></pre></td></tr></table></figure><p>以上示例的流程图示例如下：</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">  curl                     nginx (proxy_connect)            github.com</span><br><span class="line">    |                             |                          |</span><br><span class="line">(1) |-- CONNECT github.com:443 --&gt;|                          |</span><br><span class="line">    |                             |                          |</span><br><span class="line">    |                             |----[ TCP connection ]---&gt;|</span><br><span class="line">    |                             |                          |</span><br><span class="line">(2) |&lt;- HTTP/1.1 200           ---|                          |</span><br><span class="line">    |   Connection Established    |                          |</span><br><span class="line">    |                             |                          |</span><br><span class="line">    |                                                        |</span><br><span class="line">    ========= CONNECT 隧道已经被建立。========================</span><br><span class="line">    |                                                        |</span><br><span class="line">    |                             |                          |</span><br><span class="line">    |                             |                          |</span><br><span class="line">    |   [ SSL stream       ]      |                          |</span><br><span class="line">(3) |---[ GET / HTTP/1.1   ]-----&gt;|   [ SSL stream       ]   |</span><br><span class="line">    |   [ Host: github.com ]      |---[ GET / HTTP/1.1   ]--&gt;.</span><br><span class="line">    |                             |   [ Host: github.com ]   |</span><br><span class="line">    |                             |                          |</span><br><span class="line">    |                             |                          |</span><br><span class="line">    |                             |                          |</span><br><span class="line">    |                             |   [ SSL stream       ]   |</span><br><span class="line">    |   [ SSL stream       ]      |&lt;--[ HTTP/1.1 200 OK  ]---&apos;</span><br><span class="line">(4) |&lt;--[ HTTP/1.1 200 OK  ]------|   [ &lt; html page &gt;    ]   |</span><br><span class="line">    |   [ &lt; html page &gt;    ]      |                          |</span><br><span class="line">    |                             |                          |</span><br></pre></td></tr></table></figure><h1 id="Install"><a href="#Install" class="headerlink" title="Install"></a>Install</h1><ul><li>源码安装此模块：</li></ul><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ ./configure --add-module=./modules/ngx_http_proxy_connect_module</span><br><span class="line">$ make &amp;&amp; make install</span><br></pre></td></tr></table></figure><h1 id="Directive"><a href="#Directive" class="headerlink" title="Directive"></a>Directive</h1><h2 id="proxy-connect"><a href="#proxy-connect" class="headerlink" title="proxy_connect"></a>proxy_connect</h2><p>Syntax: <strong>proxy_connect</strong><br>Default: <code>none</code><br>Context: <code>server</code></p><p>开启对HTTP方法&quot;CONNECT&quot;的支持。</p><h2 id="proxy-connect-allow"><a href="#proxy-connect-allow" class="headerlink" title="proxy_connect_allow"></a>proxy_connect_allow</h2><p>Syntax: <strong>proxy_connect_allow <code>all | [port ...] | [port-range ...]</code></strong><br>Default: <code>443 563</code><br>Context: <code>server</code></p><p>该指令指定允许开启CONNECT方法的端口。<br>默认情况下，只有443和563端口被允许。</p><p>使用如下参数来修改默认行为：</p><p><code>all</code>值允许所有端口。</p><p><code>port</code>指定允许的特定端口。</p><p><code>port-range</code>指定允许的指定端口范围，示例：</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">proxy_connect_allow 1000-2000 3000-4000; # 允许端口范围1000-2000 和 3000-4000</span><br></pre></td></tr></table></figure><h2 id="proxy-connect-connect-timeout"><a href="#proxy-connect-connect-timeout" class="headerlink" title="proxy_connect_connect_timeout"></a>proxy_connect_connect_timeout</h2><p>Syntax: <strong>proxy_connect_connect_timeout <code>time</code></strong><br>Default: <code>none</code><br>Context: <code>server</code></p><p>指定与对端服务器建联的超时时间。</p><h2 id="proxy-connect-read-timeout"><a href="#proxy-connect-read-timeout" class="headerlink" title="proxy_connect_read_timeout"></a>proxy_connect_read_timeout</h2><p>Syntax: <strong>proxy_connect_read_timeout <code>time</code></strong><br>Default: <code>60s</code><br>Context: <code>server</code></p><p>指定读对端服务器数据的等待时间。<br>超时时间仅在两次读数据之间生效，而不是整个应答数据时间。<br>如果对端服务器在超时时间内未发送任何数据，连接将被关闭。</p><h2 id="proxy-connect-send-timeout"><a href="#proxy-connect-send-timeout" class="headerlink" title="proxy_connect_send_timeout"></a>proxy_connect_send_timeout</h2><p>Syntax: <strong>proxy_connect_send_timeout <code>time</code></strong><br>Default: <code>60s</code><br>Context: <code>server</code></p><p>指定发送数据到对端服务器的等待时间。<br>超时时间仅在两次发送数据之间生效，而不是整个请求时间。<br>如果对端服务器在等待时间内未收取任何数据，连接将被关闭。</p><h2 id="proxy-connect-address"><a href="#proxy-connect-address" class="headerlink" title="proxy_connect_address"></a>proxy_connect_address</h2><p>Syntax: <strong>proxy_connect_address <code>address | off</code></strong><br>Default: <code>none</code><br>Context: <code>server</code></p><p>指定对端服务器的地址。该值可以包含变量。<br>值<code>off</code>或者不设置该指令，则对端服务器的地址将CONNECT请求行的host字段提取并解析（如查询DNS）。</p><h2 id="proxy-connect-bind"><a href="#proxy-connect-bind" class="headerlink" title="proxy_connect_bind"></a>proxy_connect_bind</h2><p>Syntax: <strong>proxy_connect_bind <code>address [transparent] | off</code></strong><br>Default: <code>none</code><br>Context: <code>server</code></p><p>指定与对端服务器的连接的来源地址。<br>该值可以包含变量。值<code>off</code>或者不设置该指令将由系统自动分配来源地址和端口。</p><p><code>transparent</code>参数值使与对端服务器的连接的来源地址为非本地地址。示例如下（使用客户端地址作为来源地址）：</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">proxy_connect_bind $remote_addr transparent;</span><br></pre></td></tr></table></figure><p>为了使<code>transparent</code>参数生效，需要配置内核路由表去截获来自对端服务器的网络流量。</p><h1 id="Variables"><a href="#Variables" class="headerlink" title="Variables"></a>Variables</h1><h2 id="connect-host"><a href="#connect-host" class="headerlink" title="$connect_host"></a>$connect_host</h2><p>CONNECT请求行的主机名(host)字段。</p><h2 id="connect-port"><a href="#connect-port" class="headerlink" title="$connect_port"></a>$connect_port</h2><p>CONNECT请求行的端口(port)字段。</p><h2 id="connect-addr"><a href="#connect-addr" class="headerlink" title="$connect_addr"></a>$connect_addr</h2><p>对端服务器的IP地址和端口，如&quot;192.168.1.5:12345&quot;。</p><h2 id="proxy-connect-connect-timeout-1"><a href="#proxy-connect-connect-timeout-1" class="headerlink" title="$proxy_connect_connect_timeout"></a>$proxy_connect_connect_timeout</h2><p>获取和设置<a href="#proxy_connect_connect_timeout"><code>proxy_connect_connect_timeout</code>指令</a>的超时时间。</p><p>示例如下：</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 设置默认值</span><br><span class="line"></span><br><span class="line">proxy_connect_connect_timeout   10s;</span><br><span class="line">proxy_connect_read_timeout      10s;</span><br><span class="line">proxy_connect_send_timeout      10s;</span><br><span class="line"></span><br><span class="line"># 覆盖默认值</span><br><span class="line"></span><br><span class="line">if ($host = &quot;test.com&quot;) &#123;</span><br><span class="line">    set $proxy_connect_connect_timeout  &quot;10ms&quot;;</span><br><span class="line">    set $proxy_connect_read_timeout     &quot;10ms&quot;;</span><br><span class="line">    set $proxy_connect_send_timeout     &quot;10ms&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="proxy-connect-read-timeout-1"><a href="#proxy-connect-read-timeout-1" class="headerlink" title="$proxy_connect_read_timeout"></a>$proxy_connect_read_timeout</h2><p>获取和设置<a href="#proxy_connect_read_timeout"><code>proxy_connect_read_timeout</code>指令</a>的超时时间。</p><h2 id="proxy-connect-send-timeout-1"><a href="#proxy-connect-send-timeout-1" class="headerlink" title="$proxy_connect_send_timeout"></a>$proxy_connect_send_timeout</h2><p>获取和设置<a href="#proxy_connect_send_timeout"><code>proxy_connect_send_timeout</code>指令</a>的超时时间。</p><h1 id="Known-Issues"><a href="#Known-Issues" class="headerlink" title="Known Issues"></a>Known Issues</h1><ul><li>不支持HTTP/2的CONNECT方法。CONNECT方法仅支持HTTP/1.x和HTTPS。</li></ul></div></div></article></div></div></section></div><div class="container-fluid global-footer"><div class="row"><div class="container"><div class="row"><div class="col-lg-6 col-xs-6"><div class="footer-logo"></div></div><div class="col-lg-6 col-xs-6 clearfix"><select class="lang-switch pull-right"></select></div><div class="col-lg-12 col-lg-offset-0 col-xs-offset-1 col-xs-10"><span class="footer-text copyright">&copy; 2011-2023 <a href="https://www.alibabagroup.com/" target="_blank">Alibaba Group</a>. All rights reserved.</span> <span class="footer-text design-by">Designed by Aliyun UED AX, Proudly powered by <a href="https://github.com/alibaba/tengine-ingress" target="_blank">Tengine-Ingress</a> on <a href="https://www.aliyun.com/" target="_blank">Aliyun</a>.</span></div></div></div></div></div><script src="/js/base.min.js"></script><script src="/js/app.min.js"></script></body></html>