<!DOCTYPE html><html lang="cn" dir="ltr" class="no-js" data-env="dev-env"><head><meta name="generator" content="Hexo 3.9.0"><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-SNH2MHXGCW"></script><script>window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-SNH2MHXGCW');</script><meta charset="utf-8"><meta name="renderer" content="webkit"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="author" content="Designed by 阿里云UED AX"><title>Tengine-Ingress 快速开始 - The Tengine Web Server</title><meta name="description" content="一、Ingress 镜像开发者可以直接使用 Tengine-Ingress 提供的镜像，镜像基于Anolis OS和Alpine OS ，支持 AMD64 和 ARM64 架构。镜像拉取方式：docker pull tengine-ingress-registry.cn-hangzhou.cr.aliyuncs.com/tengine/tengine-ingress:1.1.0docker pul"><meta property="og:type" content="article"><meta property="og:title" content="Tengine-Ingress 快速开始"><meta property="og:url" content="http://tengine.taobao.org/document_cn/ingress_quickstart_cn.html"><meta property="og:site_name" content="The Tengine Web Server"><meta property="og:description" content="一、Ingress 镜像开发者可以直接使用 Tengine-Ingress 提供的镜像，镜像基于Anolis OS和Alpine OS ，支持 AMD64 和 ARM64 架构。镜像拉取方式：docker pull tengine-ingress-registry.cn-hangzhou.cr.aliyuncs.com/tengine/tengine-ingress:1.1.0docker pul"><meta property="og:locale" content="default"><meta property="og:updated_time" content="2023-11-06T08:26:24.426Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Tengine-Ingress 快速开始"><meta name="twitter:description" content="一、Ingress 镜像开发者可以直接使用 Tengine-Ingress 提供的镜像，镜像基于Anolis OS和Alpine OS ，支持 AMD64 和 ARM64 架构。镜像拉取方式：docker pull tengine-ingress-registry.cn-hangzhou.cr.aliyuncs.com/tengine/tengine-ingress:1.1.0docker pul"><link rel="alternate" href="/atom.xml" title="The Tengine Web Server" type="application/atom+xml"><link rel="stylesheet" href="/css/base.min.css"><link rel="stylesheet" href="/css/main.css"></head><body class="page-is-loading"><div class="container-fluid"><div class="row global-header"><div class="container"><div class="row"><div class="col-lg-12"><div class="row"><div class="navbar-header col-lg-2 col-xs-12"><button aria-controls="nav-menu" aria-expanded="false" class="navbar-toggle collapsed" data-target="#nav-menu" data-toggle="collapse" type="button"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button><h1 class="text-muted site-logo navbar-brand"><a href="/" id="logo" class="text-hide">The Tengine Web Server</a></h1></div><div class="col-lg-10 col-xs-12"><nav id="nav-menu" class="navbar-collapse collapse" aria-expanded="false"><ul class="nav navbar-nav navbar-right"><li role="presentation"><a class="menu-item" href="/documentation.html">Tengine</a></li><li role="presentation"><a class="menu-item" href="/guide.html">Tengine-Ingress</a></li><li role="presentation"><a class="menu-item" href="/blog.html">Blog</a></li><li role="presentation"><a class="menu-item" href="/download.html">Download</a></li><li role="presentation"><a class="menu-item" href="/source.html">Source</a></li><li role="presentation"><a class="menu-item" href="/contact.html">Contact</a></li><li role="presentation"><a class="menu-item" href="/faq.html">FAQ</a></li><li role="presentation" class="col-hide-xs"><select class="lang-switch pull-right"></select></li><li role="presentation" class="hide"><a href="#"><i class="fa fa-bars" aria-hidden="true"></i></a></li></ul></nav></div></div></div></div></div></div></div><div class="container-fluid" id="main"><section class="row"><div class="fluid-container"><div class="container"><article id="post-document_cn/ingress_quickstart_cn" class="article article-type-post" itemscope itemprop="blogPost"><div class="article-inner"><header class="article-header"><h1 class="article-title" itemprop="name">Tengine-Ingress 快速开始</h1></header><div class="article-entry" itemprop="articleBody"><h2 id="一、Ingress-镜像"><a href="#一、Ingress-镜像" class="headerlink" title="一、Ingress 镜像"></a>一、Ingress 镜像</h2><p>开发者可以直接使用 Tengine-Ingress 提供的镜像，镜像基于<a href="https://hub.docker.com/r/openanolis/anolisos" target="_blank" rel="noopener">Anolis OS</a>和<a href="https://hub.docker.com/_/alpine" target="_blank" rel="noopener">Alpine OS</a> ，支持 AMD64 和 ARM64 架构。</p><p>镜像拉取方式：</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker pull tengine-ingress-registry.cn-hangzhou.cr.aliyuncs.com/tengine/tengine-ingress:1.1.0</span><br><span class="line">docker pull tengine-ingress-registry.cn-hangzhou.cr.aliyuncs.com/tengine/tengine-ingress:1.1.0-alpine</span><br></pre></td></tr></table></figure><p>如需额外增加功能，可以基于此镜像二次开发；也可通过源码重新编译构建，参考 <a href="https://github.com/alibaba/tengine-ingress#building-from-source" target="_blank" rel="noopener">building-from-source</a></p><h2 id="二、在-Kubernetes-集群使用"><a href="#二、在-Kubernetes-集群使用" class="headerlink" title="二、在 Kubernetes 集群使用"></a>二、在 Kubernetes 集群使用</h2><h3 id="1-Tengine-Ingress-Deployment"><a href="#1-Tengine-Ingress-Deployment" class="headerlink" title="1. Tengine-Ingress Deployment"></a>1. Tengine-Ingress Deployment</h3><p>在 Kubernetes 集群中可以使用 Deployment 部署 Tengine-Ingress 集群，示例配置如下：</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tengine-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">tengine</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">tengine</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tengine</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">tengine-ingress-registry.cn-hangzhou.cr.aliyuncs.com/tengine/tengine-ingress:1.1.0</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">command:</span> <span class="string">["/usr/bin/dumb-init"]</span></span><br><span class="line">        <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">"--"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">"/tengine-ingress-controller"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">"--configmap=default/tengine-ingress-configuration"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">"--controller-class=k8s.io/tengine-ingress"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">"--annotations-prefix=nginx.ingress.kubernetes.io"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">"--v=1"</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">log_level</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"1"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">"POD_NAME"</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">"metadata.name"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">"POD_NAMESPACE"</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">"metadata.namespace"</span></span><br></pre></td></tr></table></figure><p>其中 <code>--configmap</code> 参数指定 Tengine Ingress Configmap 配置。Deployment 可以通过 <code>kubectl apply -f deployment.yaml</code> 执行生效。</p><h3 id="2-Configmap"><a href="#2-Configmap" class="headerlink" title="2. Configmap"></a>2. Configmap</h3><p>通过 Configmap 可以开启/关闭增强功能，创建示例</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tengine-ingress-configuration</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">data:</span></span><br></pre></td></tr></table></figure><p>示例仅创建空 Configmap，通过 <code>kubectl create -f configmap.yaml</code> 执行生效</p><h3 id="3-权限"><a href="#3-权限" class="headerlink" title="3. 权限"></a>3. 权限</h3><p>Tengine-Ingress 运行时需要一系列权限，以便于监听更新相关配置，权限配置示例如下：</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tengine-reader</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> <span class="string">[""]</span></span><br><span class="line">  <span class="attr">resources:</span> <span class="string">["pods"]</span></span><br><span class="line">  <span class="attr">verbs:</span> <span class="string">[</span> <span class="string">"get"</span><span class="string">,</span> <span class="string">"list"</span><span class="string">,</span> <span class="string">"watch"</span><span class="string">]</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> <span class="string">["coordination.k8s.io"]</span></span><br><span class="line">  <span class="attr">resources:</span> <span class="string">["leases"]</span></span><br><span class="line">  <span class="attr">verbs:</span> <span class="string">[</span> <span class="string">"get"</span><span class="string">,</span> <span class="string">"list"</span><span class="string">,</span> <span class="string">"watch"</span><span class="string">,</span> <span class="string">"create"</span><span class="string">,</span> <span class="string">"update"</span><span class="string">]</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">default-tengine-reader</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tengine-reader</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tengine-cluster-role</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> <span class="string">[""]</span></span><br><span class="line">  <span class="attr">resources:</span> <span class="string">["secrets",</span> <span class="string">"configmaps"</span><span class="string">,</span> <span class="string">"endpoints"</span><span class="string">,</span> <span class="string">"services"</span><span class="string">]</span></span><br><span class="line">  <span class="attr">verbs:</span> <span class="string">[</span> <span class="string">"get"</span><span class="string">,</span> <span class="string">"list"</span><span class="string">,</span> <span class="string">"watch"</span><span class="string">]</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> <span class="string">["networking.k8s.io"]</span></span><br><span class="line">  <span class="attr">resources:</span> <span class="string">["ingresses",</span> <span class="string">"ingressclasses"</span><span class="string">]</span></span><br><span class="line">  <span class="attr">verbs:</span> <span class="string">[</span> <span class="string">"get"</span><span class="string">,</span> <span class="string">"list"</span><span class="string">,</span> <span class="string">"watch"</span><span class="string">]</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> <span class="string">["networking.k8s.io"]</span></span><br><span class="line">  <span class="attr">resources:</span> <span class="string">["ingresses/status"]</span></span><br><span class="line">  <span class="attr">verbs:</span> <span class="string">[</span> <span class="string">"get"</span><span class="string">,</span> <span class="string">"update"</span><span class="string">]</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tengine-cluster-role-binding</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tengine-cluster-role</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">default</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br></pre></td></tr></table></figure><p>通过 <code>kubectl apply -f auth.yaml</code> 执行生效。</p><h3 id="3-IngressClass"><a href="#3-IngressClass" class="headerlink" title="3. IngressClass"></a>3. IngressClass</h3><p>创建默认 IngressClass 资源对象</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">IngressClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">ingressclass.kubernetes.io/is-default-class:</span> <span class="string">"true"</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">default-ingress-class</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">controller:</span> <span class="string">k8s.io/tengine-ingress</span></span><br></pre></td></tr></table></figure><h3 id="4-后端服务"><a href="#4-后端服务" class="headerlink" title="4. 后端服务"></a>4. 后端服务</h3><p>示例中创建一个 http 后端服务用于测试，同时创建相对应的 service 用于服务发现：</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">echo-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">echo</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">echo</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">echo</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">hashicorp/http-echo:latest</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">args:</span> <span class="string">["-listen",</span> <span class="string">":80"</span><span class="string">,</span> <span class="string">"-text"</span><span class="string">,</span> <span class="string">"hello world"</span><span class="string">]</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">echo-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">echo</span></span><br></pre></td></tr></table></figure><h3 id="5-Ingress-资源"><a href="#5-Ingress-资源" class="headerlink" title="5. Ingress 资源"></a>5. Ingress 资源</h3><p>创建一个 Ingress 资源，创建域名 <code>echo.test.com</code> 转发至测试的 <code>echo</code> 服务：</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">echo-test-ingress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">echo.test.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">echo-service</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><p>执行生效后，可以通过 <code>curl -k &quot;https://${POD_IP}/&quot; -H &quot;host:echo.test.com&quot;</code> 验证可用性，得到结果 <code>hello world</code>。其中 <code>${POD_IP}</code> 为监听处理这个 <code>ingress</code> 资源对象的 <code>tengine-ingress</code> Pod 的 IP。</p><h2 id="三、增强功能示例"><a href="#三、增强功能示例" class="headerlink" title="三、增强功能示例"></a>三、增强功能示例</h2><h3 id="1-新增证书"><a href="#1-新增证书" class="headerlink" title="1. 新增证书"></a>1. 新增证书</h3><p>新证书可写入 k8s <code>secret</code> 资源，示例使用 <code>kubectl</code> 写入</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">kubectl create secret tls https-server-1 --key certs/server_1.key --cert certs/server_1.crt</span><br></pre></td></tr></table></figure><p>写入名为 <code>https-server-1</code> 的 <code>secret</code>，通过 <code>ingress</code> 资源指定证书：</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">minimal-ingress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">echo.test.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">echo-service</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">tls:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo.test.com</span></span><br><span class="line">    <span class="attr">secretName:</span> <span class="string">https-server-1</span></span><br></pre></td></tr></table></figure><p>指定以后，访问域名 <code>echo.test.com</code> 即可使用证书 <code>https-server-1</code>。</p><h3 id="2-使用-HTTP3"><a href="#2-使用-HTTP3" class="headerlink" title="2. 使用 HTTP3"></a>2. 使用 HTTP3</h3><p><strong>注意1：仅在<code>Tengine-Ingress 1.1.0</code>版本以上有效。</strong><br><strong>注意2：如用浏览器访问，需要确保使用证书可信</strong></p><p>镜像中 HTTP3 默认监听端口为 443，默认会下发 <code>Alt-Svc</code> 切换 443 端口的 HTTP3。如证书受信，启动后默认开启 HTTP3 无需额外配置。</p><p>浏览器访问时，第一个请求为 HTTP1.1 / HTTP2 请求，<code>tenigne</code> 返回 <code>header</code> 的 <code>Alt-Svc</code> 指引浏览器进行协议切换，后续请求会切换为 HTTP3。</p><p>如需修改 xquic 默认端口，可通过 <code>configmap</code> 中的 <code>http3-xquic-default-port</code> 配置。</p><h3 id="3-开启-xudp"><a href="#3-开启-xudp" class="headerlink" title="3. 开启 xudp"></a>3. 开启 <code>xudp</code></h3><p><strong>注：xudp仅为了性能优化，没有相关配置并不影响HTTP3功能使用。</strong></p><p><code>xudp</code> 实现了内核的用户态的高性能 <code>UDP</code> 收发，可极大提升 <code>QUIC</code> 协议 <code>UDP</code> 传输性能，目前 xudp 能力仅在 <a href="https://hub.docker.com/r/openanolis/anolisos" target="_blank" rel="noopener">Anolis OS</a> 系统上支持（<strong>注意：需要宿主机和 docker 都是 Anolis OS 系统才能支持 xudp 特性</strong>）：。通过 <code>Configmap</code> 可以很方便的开启/关闭 <code>xudp</code>能力。</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tengine-ingress-configuration</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">use-xquic-xudp:</span> <span class="string">"true"</span></span><br><span class="line">  <span class="attr">main-snippet:</span> <span class="string">|</span></span><br><span class="line">    <span class="string">xudp_core_path</span> <span class="string">/usr/local/lib64/xquic_xdp/kern_xquic.o;</span></span><br><span class="line">    <span class="string">xudp_rcvnum</span> <span class="number">2048</span><span class="string">;</span></span><br><span class="line">    <span class="string">xudp_sndnum</span> <span class="number">4096</span><span class="string">;</span></span><br></pre></td></tr></table></figure><p>加载成功后可以看到 <code>listen</code> 指令增加了 <code>xudp</code> 的选项，同时 <code>main</code> 配置段增加了 <code>xudp_core_path</code> 配置。</p><h3 id="4-强制跳转-https"><a href="#4-强制跳转-https" class="headerlink" title="4. 强制跳转 https"></a>4. 强制跳转 <code>https</code></h3><p>在 <code>ingress</code> 资源增加 <code>Annotations</code> 可以控制路由转发的部分逻辑，如通过 <code>nginx.ingress.kubernetes.io/ssl-redirect</code> 可以控制是否强制调整 <code>https</code>，默认开启，先增加示例关闭此功能：</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">echo-test-ingress</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/ssl-redirect:</span> <span class="string">"false"</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">echo.test.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">echo-service</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><p>可以看到，在增加了 <code>nginx.ingress.kubernetes.io/ssl-redirect</code> 后，再次执行 <code>curl &quot;http://${INGRESS_IP}/&quot; -H &quot;host:echo.test.com&quot;</code> 就不会跳转至 <code>https</code>，直接返回内容 <code>hello world</code>。</p></div></div></article></div></div></section></div><div class="container-fluid global-footer"><div class="row"><div class="container"><div class="row"><div class="col-lg-6 col-xs-6"><div class="footer-logo"></div></div><div class="col-lg-6 col-xs-6 clearfix"><select class="lang-switch pull-right"></select></div><div class="col-lg-12 col-lg-offset-0 col-xs-offset-1 col-xs-10"><span class="footer-text copyright">&copy; 2011-2023 <a href="https://www.alibabagroup.com/" target="_blank">Alibaba Group</a>. All rights reserved.</span> <span class="footer-text design-by">Designed by Aliyun UED AX, Proudly powered by <a href="https://github.com/alibaba/tengine-ingress" target="_blank">Tengine-Ingress</a> on <a href="https://www.aliyun.com/" target="_blank">Aliyun</a>.</span></div></div></div></div></div><script src="/js/base.min.js"></script><script src="/js/app.min.js"></script></body></html>