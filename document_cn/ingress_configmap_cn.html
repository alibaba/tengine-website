<!DOCTYPE html><html lang="cn" dir="ltr" class="no-js" data-env="dev-env"><head><meta name="generator" content="Hexo 3.9.0"><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-SNH2MHXGCW"></script><script>window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-SNH2MHXGCW');</script><meta charset="utf-8"><meta name="renderer" content="webkit"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="author" content="Designed by 阿里云UED AX"><title>Tengine-Ingress 全局配置Configmap - The Tengine Web Server</title><meta name="description" content="Tengine-Ingress完全兼容云原生ingress标准规范，用户可参照kubernetes ingress-nginx相关文档。在此列出Tengine-Ingress原生扩展和增强功能的Configmap。注意：Tengine-Ingress基于默认初始化的Configmap可以正常运行，如果需要修改Configmap中的配置，则必须tengine reload生效配置。Configmap"><meta property="og:type" content="article"><meta property="og:title" content="Tengine-Ingress 全局配置Configmap"><meta property="og:url" content="http://tengine.taobao.org/document_cn/ingress_configmap_cn.html"><meta property="og:site_name" content="The Tengine Web Server"><meta property="og:description" content="Tengine-Ingress完全兼容云原生ingress标准规范，用户可参照kubernetes ingress-nginx相关文档。在此列出Tengine-Ingress原生扩展和增强功能的Configmap。注意：Tengine-Ingress基于默认初始化的Configmap可以正常运行，如果需要修改Configmap中的配置，则必须tengine reload生效配置。Configmap"><meta property="og:locale" content="default"><meta property="og:updated_time" content="2023-11-09T13:12:36.736Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Tengine-Ingress 全局配置Configmap"><meta name="twitter:description" content="Tengine-Ingress完全兼容云原生ingress标准规范，用户可参照kubernetes ingress-nginx相关文档。在此列出Tengine-Ingress原生扩展和增强功能的Configmap。注意：Tengine-Ingress基于默认初始化的Configmap可以正常运行，如果需要修改Configmap中的配置，则必须tengine reload生效配置。Configmap"><link rel="alternate" href="/atom.xml" title="The Tengine Web Server" type="application/atom+xml"><link rel="stylesheet" href="/css/base.min.css"><link rel="stylesheet" href="/css/main.css"></head><body class="page-is-loading"><div class="container-fluid"><div class="row global-header"><div class="container"><div class="row"><div class="col-lg-12"><div class="row"><div class="navbar-header col-lg-2 col-xs-12"><button aria-controls="nav-menu" aria-expanded="false" class="navbar-toggle collapsed" data-target="#nav-menu" data-toggle="collapse" type="button"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button><h1 class="text-muted site-logo navbar-brand"><a href="/" id="logo" class="text-hide">The Tengine Web Server</a></h1></div><div class="col-lg-10 col-xs-12"><nav id="nav-menu" class="navbar-collapse collapse" aria-expanded="false"><ul class="nav navbar-nav navbar-right"><li role="presentation"><a class="menu-item" href="/documentation.html">Tengine</a></li><li role="presentation"><a class="menu-item" href="/guide.html">Tengine-Ingress</a></li><li role="presentation"><a class="menu-item" href="/blog.html">Blog</a></li><li role="presentation"><a class="menu-item" href="/download.html">Download</a></li><li role="presentation"><a class="menu-item" href="/source.html">Source</a></li><li role="presentation"><a class="menu-item" href="/contact.html">Contact</a></li><li role="presentation"><a class="menu-item" href="/faq.html">FAQ</a></li><li role="presentation" class="col-hide-xs"><select class="lang-switch pull-right"></select></li><li role="presentation" class="hide"><a href="#"><i class="fa fa-bars" aria-hidden="true"></i></a></li></ul></nav></div></div></div></div></div></div></div><div class="container-fluid" id="main"><section class="row"><div class="fluid-container"><div class="container"><article id="post-document_cn/ingress_configmap_cn" class="article article-type-post" itemscope itemprop="blogPost"><div class="article-inner"><header class="article-header"><h1 class="article-title" itemprop="name">Tengine-Ingress 全局配置Configmap</h1></header><div class="article-entry" itemprop="articleBody"><p><code>Tengine-Ingress</code>完全兼容云原生<a href="https://kubernetes.io/docs/concepts/services-networking/ingress/" target="_blank" rel="noopener">ingress</a>标准规范，用户可参照<a href="https://kubernetes.github.io/ingress-nginx/" target="_blank" rel="noopener">kubernetes ingress-nginx</a>相关文档。<br>在此列出<a href="https://github.com/alibaba/tengine-ingress" target="_blank" rel="noopener">Tengine-Ingress</a>原生扩展和增强功能的Configmap。</p><p><strong>注意：Tengine-Ingress基于默认初始化的Configmap可以正常运行，如果需要修改Configmap中的配置，则必须tengine reload生效配置。</strong></p><h2 id="Configmap"><a href="#Configmap" class="headerlink" title="Configmap"></a>Configmap</h2><blockquote><p>Syntax: <strong>https-allow-http</strong> <code>true</code>;<br>Default: <code>false</code></p></blockquote><p>如果设置<code>https-allow-http: &#39;true&#39;</code>，则在listen指令中添加https_allow_http选项，表示该端口允许在SSL开启的情况下接收HTTP请求。</p><hr><blockquote><p>Syntax: <strong>custom-port-domain</strong> <code>443: aaa.com, 2443: bbb.com, 3443: ccc.com</code>;<br>Default: <code></code></p></blockquote><p>设置证书端口映射表，通过不同的TLS端口与根域名的映射关系，动态匹配对应的证书。<br>当客户端TLS建链Client Hello请求不携带SNI，Tengine-Ingress通过端口匹配对应的证书用于TLS握手。</p><hr><blockquote><p>Syntax: <strong>tengine-reload</strong> <code>false</code>;<br>Default: <code>false</code></p></blockquote><p>默认设置<code>tengine-reload: &#39;false&#39;</code>，则在新增，修改或删除ingress和secret资源对象时，都<strong>无需tengine reload</strong>，即开启配置动态无损生效模式。</p><hr><blockquote><p>Syntax: <strong>tengine-static-service-cfg</strong> <code>false</code>;<br>Default: <code>false</code></p></blockquote><p>默认设置<code>tengine-static-service-cfg: &#39;false&#39;</code>，则在新增，修改或删除ingress和secret资源对象时，都不再更新nginx.conf配置文件，tengine仅从共享内存中获取应用域名和证书配置。</p><hr><blockquote><p>Syntax: <strong>filelock-shm-service-cfg</strong> <code>/etc/nginx/shm_service_cfg.lock</code>;<br>Default: <code>/etc/nginx/shm_service_cfg.lock</code></p></blockquote><p>通过配置<code>filelock-shm-service-cfg</code>设置共享内存文件锁的路径。Tengine-Ingress控制器通过订阅和处理ingress域名资源和secret证书资源，基于tengine ingress模板转换为动态配置写入共享内存。Tengine-proxy订阅共享内存变化写入内部运行时共享内存，将终端用户的外部流量路由到K8s集群中的应用服务。</p><hr><blockquote><p>Syntax: <strong>filepath-status-tengine</strong> <code>/etc/nginx/htdocs/status.tengine</code>;<br>Default: <code>/etc/nginx/htdocs/status.tengine</code></p></blockquote><p>对tengine设置HTTP健康检查的文件路径，通过默认80和443端口请求<code>/status.tengine</code>，如果tengine-proxy健康状态正常，则返回<code>/etc/nginx/htdocs/status.tengine</code>。<br>默认封禁应用域名的<code>/status.tengine</code>请求，tengine-proxy直接返回404。</p><hr><blockquote><p>Syntax: <strong>ingress-shm-size</strong> <code>268435456</code>;<br>Default: <code>268435456</code></p></blockquote><p>设置Ingress共享内存大小，默认256MB共享内存可存储超过3万个Ingress资源对象。</p><hr><blockquote><p>Syntax: <strong>tengine-ingress-app-name</strong> <code>tengine-ingress</code>;<br>Default: <code>tengine-ingress</code></p></blockquote><p>设置请求header <code>X-Request-From: tengine-ingress</code>，标识请求是通过网关<code>tengine-ingress</code>路由转发。</p><hr><blockquote><p>Syntax: <strong>use-ingress-storage-cluster</strong> <code>true</code>;<br>Default: <code>false</code></p></blockquote><p>Tengine-Ingress支持K8s core集群与K8s ingress存储集群相隔离的高可靠性部署方案，将运行态和存储态相分离，独立K8s ingress集群可以保证自身API服务器和etcd性能稳定，并且在core集群核心组件API服务器和etcd不可用的高危场景下也能正常向外提供7层转发服务。如果设置<code>use-ingress-storage-cluster: &#39;true&#39;</code>，则tengine-ingress将通过启动命令行参数<code>--kubeconfig</code>中的kubeconfig从独立K8s ingress存储集群获取Ingress和Secret资源对象，而configmap仍然从tengine-ingress所在的K8s core集群中获取。</p><hr><blockquote><p>Syntax: <strong>use-ingress-checksum</strong> <code>true</code>;<br>Default: <code>false</code></p></blockquote><p>Tengine-Ingress通过全局一致性校验机制保障内存中运行态持有的用户侧ingress域名的有效性和正确性，在域名配置不符合标准化k8s资源ingress规范及其相关RFC标准时，将不再更新本地缓存，保障运行态永远可正常向外提供7层转发服务。如果设置<code>use-ingress-checksum: &#39;true&#39;</code>，Tengine-ingress基于ingress全局一致性校验算法计算全局MD5值，与CRD ingresschecksums资源对象中的MD5值相匹配，则表明本次更新的ingress资源对象是全局一致性，即可将ingress资源对象更新到本地缓存，并写入共享内存，开始使用最新的ingress域名配置对外提供HTTP(S)七层负载均衡，TLS卸载和路由转发功能；否则表明更新的ingress资源对象全局不一致，系统存在脏数据，不再更新本地缓存和共享内存，仍旧使用存量的ingress域名配置对外提供HTTP(S)接入服务，保证运行态域名接入和路由服务的正确性和可靠性。</p><hr><blockquote><p>Syntax: <strong>use-secret-checksum</strong> <code>true</code>;<br>Default: <code>false</code></p></blockquote><p>Secret证书资源对象采用了类似的全局一致性方案。如果设置<code>use-secret-checksum: &#39;true&#39;</code>，Tengine-Ingress通过全局一致性校验机制保障内存中运行态持有的用户侧secret证书的有效性和正确性，在证书信息不符合标准化k8s资源secret规范及其相关RFC标准时，将不再更新本地缓存，保障运行态永远可正常向外提供7层转发服务。</p><hr><blockquote><p>Syntax: <strong>use-http3-xquic</strong> <code>true</code>;<br>Default: <code>true</code></p></blockquote><p>默认启用HTTP3/QUIC协议，如果设置<code>use-http3-xquic: &#39;false&#39;</code>，则Tengine-Ingress将无法处理HTTP3/QUIC报文。</p><hr><blockquote><p>Syntax: <strong>use-xquic-xudp</strong> <code>true</code>;<br>Default: <code>false</code></p></blockquote><p>默认不启用XUDP，如果设置<code>use-xquic-xudp: &#39;true&#39;</code>，容器和宿主机的操作系统都必须是<a href="https://hub.docker.com/r/openanolis/anolisos" target="_blank" rel="noopener">Anolis</a>才能使用XUDP。<br>Tengine XUDP Module主要用于在服务端启用XUDP，支持bypass内核的用户态高性能UDP转发。<br>服务端启用HTTP3/QUIC监听服务，通过配合使用XUDP，可大幅提升HTTP3转发性能。</p><hr><blockquote><p>Syntax: <strong>http3-xquic-default-port</strong> <code>443</code>;<br>Default: <code>443</code></p></blockquote><p>Tengine-Ingress默认设置HTTP3/QUIC监听端口号443。Tengine-Ingress通过响应消息头<code>Alt-Svc: h3=&quot;:443&quot;</code>协商通知客户端，客户端如果支持HTTP3，将通过端口443建立UDP连接。<br>如果需要修改<code>http3-xquic-default-port</code>，则必须同步更新tengine-ingress的启动命令行参数<code>--quic-port int</code>。<br>例如：设置<code>http3-xquic-default-port: 3443</code>，tengine-ingress启动命令行参数<code>--quic-port 3443</code>。</p><hr><blockquote><p>Syntax: <strong>canary-referrer</strong> <code>a,b,c</code>;<br>Default: -</p></blockquote><p>设置高级路由Canary Ingress资源对象的来源范围，仅允许<code>canary-referrer</code>中的应用列表创建高级路由Canary Ingress资源对象。<br>默认情况下<code>canary-referrer</code>为空，即允许所有应用创建高级路由Canary Ingress资源对象。</p><hr><blockquote><p>Syntax: <strong>ingress-referrer</strong> <code>a,b,c</code>;<br>Default: -</p></blockquote><p>设置Ingress资源对象的来源范围，仅允许<code>ingress-referrer</code>中的应用列表创建Ingress资源对象。<br>默认情况下<code>ingress-referrer</code>为空，即允许所有应用创建Ingress资源对象。</p><hr><blockquote><p>Syntax: <strong>max-canary-ing-num</strong> <code>200</code>;<br>Default: <code>200</code></p></blockquote><p>默认每个Ingress域名允许最多创建200个高级路由，每个高级路由都是独立的Canary Ingress资源对象。<br>对于超过默认200个的Canary Ingress资源对象，都将被忽略梳理。</p><hr><blockquote><p>Syntax: <strong>max-canary-action-num</strong> <code>10</code>;<br>Default: <code>10</code></p></blockquote><p>每个基于Canary Ingress高级路由的流量染色默认最大规则数量。<br>对于单个Canary Ingress，超过默认10条的流量染色规则都将被忽略梳理。<br>流量染色规则包括：向后端upstream转发的HTTP请求头中增加Header，在已有Header中追加Header值，或者是增加Query参数；以及向客户端转发的HTTP响应头中增加Header。</p><hr><blockquote><p>Syntax: <strong>default-canary-weight-total</strong> <code>100</code>;<br>Default: <code>100</code></p></blockquote><p>基于Canary Ingress高级路由的默认服务权重总和。</p><hr><blockquote><p>Syntax: <strong>max-canary-weight-total</strong> <code>10000</code>;<br>Default: <code>100</code></p></blockquote><p>基于Canary Ingress高级路由的最大服务权重总和。</p><hr><blockquote><p>Syntax: <strong>max-canary-header-val-num</strong> <code>20</code>;<br>Default: <code>20</code></p></blockquote><p>基于Header值的Canary Ingress高级路由默认允许匹配的Header值个数。</p><hr><blockquote><p>Syntax: <strong>max-canary-cookie-val-num</strong> <code>20</code>;<br>Default: <code>20</code></p></blockquote><p>基于Cookie值的Canary Ingress高级路由默认允许匹配的Cookie值个数。</p><hr><blockquote><p>Syntax: <strong>max-canary-query-val-num</strong> <code>20</code>;<br>Default: <code>20</code></p></blockquote><p>基于Query参数值的Canary Ingress高级路由默认允许匹配的Query参数值个数。</p><hr><blockquote><p>Syntax: <strong>max-canary-req-add-header-num</strong> <code>2</code>;<br>Default: <code>2</code></p></blockquote><p>基于Canary Ingress高级路由，向后端upstream转发HTTP请求中默认允许增加的Header个数。</p><hr><blockquote><p>Syntax: <strong>max-canary-req-append-header-num</strong> <code>2</code>;<br>Default: <code>2</code></p></blockquote><p>基于Canary Ingress高级路由，向后端upstream转发HTTP请求中默认允许追加的Header个数。</p><hr><blockquote><p>Syntax: <strong>max-canary-req-add-query-num</strong> <code>2</code>;<br>Default: <code>2</code></p></blockquote><p>基于Canary Ingress高级路由，向后端upstream转发HTTP请求中默认允许增加的Query参数个数。</p><hr><blockquote><p>Syntax: <strong>max-canary-resp-add-header-num</strong> <code>2</code>;<br>Default: <code>2</code></p></blockquote><p>基于Canary Ingress高级路由，向客户端转发HTTP响应中默认允许增加的Header个数。</p><hr><blockquote><p>Syntax: <strong>user</strong> <code>root</code>;<br>Default: <code>root</code></p></blockquote><p>默认启动tengine进程的用户角色。</p><hr><blockquote><p>Syntax: <strong>max-stop-sleep-time-for-stop</strong> <code>35</code>;<br>Default: <code>35</code><br>Unit: <code>second</code></p></blockquote><p>Tengine进程停止阶段，等待4层负载均衡流量清零的时间。<br>在4层负载均衡流量清零，4层LB不再转发报文到Tengine后，再优雅关停Tengine进程。</p></div></div></article></div></div></section></div><div class="container-fluid global-footer"><div class="row"><div class="container"><div class="row"><div class="col-lg-6 col-xs-6"><div class="footer-logo"></div></div><div class="col-lg-6 col-xs-6 clearfix"><select class="lang-switch pull-right"></select></div><div class="col-lg-12 col-lg-offset-0 col-xs-offset-1 col-xs-10"><span class="footer-text copyright">&copy; 2011-2023 <a href="https://www.alibabagroup.com/" target="_blank">Alibaba Group</a>. All rights reserved.</span> <span class="footer-text design-by">Designed by Aliyun UED AX, Proudly powered by <a href="https://github.com/alibaba/tengine-ingress" target="_blank">Tengine-Ingress</a> on <a href="https://www.aliyun.com/" target="_blank">Aliyun</a>.</span></div></div></div></div></div><script src="/js/base.min.js"></script><script src="/js/app.min.js"></script></body></html>