<!DOCTYPE html><html lang="cn" dir="ltr" class="no-js" data-env="dev-env"><head><meta charset="utf-8"><meta name="renderer" content="webkit"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="author" content="Designed by 阿里云UED AX"><title>ngx_http_upstream_check_module - The Tengine Web Server</title><meta name="description" content="该模块可以为Tengine提供主动式后端服务器健康检查的功能。该模块在Tengine-1.4.0版本以前没有默认开启，它可以在配置编译选项的时候开启：./configure --with-http_upstream_check_moduleExampleshttp &amp;#123;    upstream cluster1 &amp;#123;        # simple round-robin"><meta property="og:type" content="article"><meta property="og:title" content="ngx_http_upstream_check_module"><meta property="og:url" content="http://tengine.taobao.org/document_cn/http_upstream_check_cn.html"><meta property="og:site_name" content="The Tengine Web Server"><meta property="og:description" content="该模块可以为Tengine提供主动式后端服务器健康检查的功能。该模块在Tengine-1.4.0版本以前没有默认开启，它可以在配置编译选项的时候开启：./configure --with-http_upstream_check_moduleExampleshttp &amp;#123;    upstream cluster1 &amp;#123;        # simple round-robin"><meta property="og:updated_time" content="2016-12-09T03:47:05.000Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="ngx_http_upstream_check_module"><meta name="twitter:description" content="该模块可以为Tengine提供主动式后端服务器健康检查的功能。该模块在Tengine-1.4.0版本以前没有默认开启，它可以在配置编译选项的时候开启：./configure --with-http_upstream_check_moduleExampleshttp &amp;#123;    upstream cluster1 &amp;#123;        # simple round-robin"><link rel="alternate" href="/atom.xml" title="The Tengine Web Server" type="application/atom+xml"><link rel="stylesheet" href="/css/base.min.css"><link rel="stylesheet" href="/css/main.css"></head><body class="page-is-loading"><div class="container-fluid"><div class="row global-header"><div class="container"><div class="row"><div class="col-lg-12"><div class="row"><div class="navbar-header col-lg-2 col-xs-12"><button aria-controls="nav-menu" aria-expanded="false" class="navbar-toggle collapsed" data-target="#nav-menu" data-toggle="collapse" type="button"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button><h1 class="text-muted site-logo navbar-brand"><a href="/" id="logo" class="text-hide">The Tengine Web Server</a></h1></div><div class="col-lg-10 col-xs-12"><nav id="nav-menu" class="navbar-collapse collapse" aria-expanded="false"><ul class="nav navbar-nav navbar-right"><li role="presentation"><a class="menu-item" href="/download.html">Download</a></li><li role="presentation"><a class="menu-item" href="/source.html">Source</a></li><li role="presentation"><a class="menu-item" href="/documentation.html">Document</a></li><li role="presentation"><a class="menu-item" href="/faq.html">FAQ</a></li><li role="presentation"><a class="menu-item" href="/contact.html">Contact</a></li><li role="presentation"><a class="menu-item" href="http://tengine.taobao.org/book/">Guide</a></li><li role="presentation"><a class="menu-item" href="http://click.aliyun.com/m/4339/">Buy Server</a></li><li role="presentation" class="col-hide-xs"><select class="lang-switch pull-right"></select></li><li role="presentation" class="hide"><a href="#"><i class="fa fa-bars" aria-hidden="true"></i></a></li></ul></nav></div></div></div></div></div></div></div><div class="container-fluid" id="main"><section class="row"><div class="fluid-container"><div class="container"><article id="post-document_cn/http_upstream_check_cn" class="article article-type-post" itemscope itemprop="blogPost"><div class="article-inner"><header class="article-header"><h1 class="article-title" itemprop="name">ngx_http_upstream_check_module</h1></header><div class="article-entry" itemprop="articleBody"><p>该模块可以为Tengine提供主动式后端服务器健康检查的功能。</p><p>该模块在Tengine-1.4.0版本以前没有默认开启，它可以在配置编译选项的时候开启：<code>./configure --with-http_upstream_check_module</code></p><h2 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h2><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">http &#123;</div><div class="line">    upstream cluster1 &#123;</div><div class="line">        # simple round-robin</div><div class="line">        server 192.168.0.1:80;</div><div class="line">        server 192.168.0.2:80;</div><div class="line"></div><div class="line">        check interval=3000 rise=2 fall=5 timeout=1000 type=http;</div><div class="line">        check_http_send &quot;HEAD / HTTP/1.0\r\n\r\n&quot;;</div><div class="line">        check_http_expect_alive http_2xx http_3xx;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    upstream cluster2 &#123;</div><div class="line">        # simple round-robin</div><div class="line">        server 192.168.0.3:80;</div><div class="line">        server 192.168.0.4:80;</div><div class="line"></div><div class="line">        check interval=3000 rise=2 fall=5 timeout=1000 type=http;</div><div class="line">        check_keepalive_requests 100;</div><div class="line">        check_http_send &quot;HEAD / HTTP/1.1\r\nConnection: keep-alive\r\n\r\n&quot;;</div><div class="line">        check_http_expect_alive http_2xx http_3xx;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    server &#123;</div><div class="line">        listen 80;</div><div class="line"></div><div class="line">        location /1 &#123;</div><div class="line">            proxy_pass http://cluster1;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        location /2 &#123;</div><div class="line">            proxy_pass http://cluster2;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        location /status &#123;</div><div class="line">            check_status;</div><div class="line"></div><div class="line">            access_log   off;</div><div class="line">            allow SOME.IP.ADD.RESS;</div><div class="line">            deny all;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="指令"><a href="#指令" class="headerlink" title="指令"></a>指令</h2><blockquote><p>Syntax: <strong>check</strong> <code>interval=milliseconds [fall=count] [rise=count] [timeout=milliseconds] [default_down=true|false] [type=tcp|http|ssl_hello|mysql|ajp] [port=check_port]</code><br>Default: 如果没有配置参数，默认值是：<code>interval=30000 fall=5 rise=2 timeout=1000 default_down=true type=tcp</code><br>Context: <code>upstream</code></p></blockquote><p>该指令可以打开后端服务器的健康检查功能。</p><p>指令后面的参数意义是：</p><ul><li><code>interval</code>：向后端发送的健康检查包的间隔。</li><li><code>fall</code>(fall_count): 如果连续失败次数达到fall_count，服务器就被认为是down。</li><li><code>rise</code>(rise_count): 如果连续成功次数达到rise_count，服务器就被认为是up。</li><li><code>timeout</code>: 后端健康请求的超时时间。</li><li><code>default_down</code>: 设定初始时服务器的状态，如果是true，就说明默认是down的，如果是false，就是up的。默认值是true，也就是一开始服务器认为是不可用，要等健康检查包达到一定成功次数以后才会被认为是健康的。</li><li><code>type</code>：健康检查包的类型，现在支持以下多种类型<ul><li><code>tcp</code>：简单的tcp连接，如果连接成功，就说明后端正常。</li><li><code>ssl_hello</code>：发送一个初始的SSL hello包并接受服务器的SSL hello包。</li><li><code>http</code>：发送HTTP请求，通过后端的回复包的状态来判断后端是否存活。</li><li><code>mysql</code>: 向mysql服务器连接，通过接收服务器的greeting包来判断后端是否存活。</li><li><code>ajp</code>：向后端发送AJP协议的Cping包，通过接收Cpong包来判断后端是否存活。</li></ul></li><li><code>port</code>: 指定后端服务器的检查端口。你可以指定不同于真实服务的后端服务器的端口，比如后端提供的是443端口的应用，你可以去检查80端口的状态来判断后端健康状况。默认是0，表示跟后端server提供真实服务的端口一样。该选项出现于Tengine-1.4.0。</li></ul><hr><blockquote><p>Syntax: <strong>check_keepalive_requests</strong> <code>request_num</code><br>Default: <code>1</code><br>Context: <code>upstream</code></p></blockquote><p>该指令可以配置一个连接发送的请求数，其默认值为1，表示Tengine完成1次请求后即关闭连接。</p><hr><blockquote><p>Syntax: <strong>check_http_send</strong> <code>http_packet</code><br>Default: <code>&quot;GET / HTTP/1.0\r\n\r\n&quot;</code><br>Context: <code>upstream</code></p></blockquote><p>该指令可以配置http健康检查包发送的请求内容。为了减少传输数据量，推荐采用<code>&quot;HEAD&quot;</code>方法。</p><p>当采用长连接进行健康检查时，需在该指令中添加keep-alive请求头，如：<code>&quot;HEAD / HTTP/1.1\r\nConnection: keep-alive\r\n\r\n&quot;</code>。<br>同时，在采用<code>&quot;GET&quot;</code>方法的情况下，请求uri的size不宜过大，确保可以在1个<code>interval</code>内传输完成，否则会被健康检查模块视为后端服务器或网络异常。</p><hr><blockquote><p>Syntax: <strong>check_http_expect_alive</strong> <code>[ http_2xx | http_3xx | http_4xx | http_5xx ]</code><br>Default: <code>http_2xx | http_3xx</code><br>Context: <code>upstream</code></p></blockquote><p>该指令指定HTTP回复的成功状态，默认认为2XX和3XX的状态是健康的。</p><hr><blockquote><p>Syntax: <strong>check_shm_size</strong> <code>size</code><br>Default: <code>1M</code><br>Context: <code>http</code></p></blockquote><p>所有的后端服务器健康检查状态都存于共享内存中，该指令可以设置共享内存的大小。默认是1M，如果你有1千台以上的服务器并在配置的时候出现了错误，就可能需要扩大该内存的大小。</p><hr><blockquote><p>Syntax: <strong>check_status</strong> <code>[html|csv|json]</code><br>Default: <code>check_status html</code><br>Context: <code>location</code></p></blockquote><p>显示服务器的健康状态页面。该指令需要在http块中配置。</p><p>在Tengine-1.4.0以后，你可以配置显示页面的格式。支持的格式有: <code>html</code>、<code>csv</code>、 <code>json</code>。默认类型是<code>html</code>。</p><p>你也可以通过请求的参数来指定格式，假设‘/status’是你状态页面的URL， <code>format</code>参数改变页面的格式，比如：</p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">/status?format=html</div><div class="line">/status?format=csv</div><div class="line">/status?format=json</div></pre></td></tr></table></figure><p>同时你也可以通过status参数来获取相同服务器状态的列表，比如：</p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">/status?format=html&amp;amp;status=down</div><div class="line">/status?format=csv&amp;amp;status=up</div></pre></td></tr></table></figure><p>下面是一个HTML状态页面的例子（server number是后端服务器的数量，generation是Nginx reload的次数。Index是服务器的索引，Upstream是在配置中upstream的名称，Name是服务器IP，Status是服务器的状态，Rise是服务器连续检查成功的次数，Fall是连续检查失败的次数，Check type是检查的方式，Check port是后端专门为健康检查设置的端口）：</p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Strict//EN</div><div class="line">    &quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd&quot;&gt;</div><div class="line">    &lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;</div><div class="line">    &lt;head&gt;</div><div class="line">    &lt;title&gt;Nginx http upstream check status&lt;/title&gt;</div><div class="line">    &lt;/head&gt;</div><div class="line">    &lt;body&gt;</div><div class="line">        &lt;h1&gt;Nginx http upstream check status&lt;/h1&gt;</div><div class="line">        &lt;h2&gt;Check upstream server number: 1, generation: 3&lt;/h2&gt;</div><div class="line">        &lt;table style=&quot;background-color:white&quot; cellspacing=&quot;0&quot; cellpadding=&quot;3&quot; border=&quot;1&quot;&gt;</div><div class="line">            &lt;tr bgcolor=&quot;#C0C0C0&quot;&gt;</div><div class="line">                &lt;th&gt;Index&lt;/th&gt;</div><div class="line">                &lt;th&gt;Upstream&lt;/th&gt;</div><div class="line">                &lt;th&gt;Name&lt;/th&gt;</div><div class="line">                &lt;th&gt;Status&lt;/th&gt;</div><div class="line">                &lt;th&gt;Rise counts&lt;/th&gt;</div><div class="line">                &lt;th&gt;Fall counts&lt;/th&gt;</div><div class="line">                &lt;th&gt;Check type&lt;/th&gt;</div><div class="line">                &lt;th&gt;Check port&lt;/th&gt;</div><div class="line">            &lt;/tr&gt;</div><div class="line">            &lt;tr&gt;</div><div class="line">                &lt;td&gt;0&lt;/td&gt;</div><div class="line">                &lt;td&gt;backend&lt;/td&gt;</div><div class="line">                &lt;td&gt;106.187.48.116:80&lt;/td&gt;</div><div class="line">                &lt;td&gt;up&lt;/td&gt;</div><div class="line">                &lt;td&gt;39&lt;/td&gt;</div><div class="line">                &lt;td&gt;0&lt;/td&gt;</div><div class="line">                &lt;td&gt;http&lt;/td&gt;</div><div class="line">                &lt;td&gt;80&lt;/td&gt;</div><div class="line">            &lt;/tr&gt;</div><div class="line">        &lt;/table&gt;</div><div class="line">    &lt;/body&gt;</div><div class="line">    &lt;/html&gt;</div></pre></td></tr></table></figure><p>下面是csv格式页面的例子：</p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">0,backend,106.187.48.116:80,up,46,0,http,80</div></pre></td></tr></table></figure><p>下面是json格式页面的例子：</p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">&#123;&quot;servers&quot;: &#123;</div><div class="line">  &quot;total&quot;: 1,</div><div class="line">  &quot;generation&quot;: 3,</div><div class="line">  &quot;server&quot;: [</div><div class="line">   &#123;&quot;index&quot;: 0, &quot;upstream&quot;: &quot;backend&quot;, &quot;name&quot;: &quot;106.187.48.116:80&quot;, &quot;status&quot;: &quot;up&quot;, &quot;rise&quot;: 58, &quot;fall&quot;: 0, &quot;type&quot;: &quot;http&quot;, &quot;port&quot;: 80&#125;</div><div class="line">  ]</div><div class="line"> &#125;&#125;</div></pre></td></tr></table></figure><div class="advertisement"><h3>Advertisement</h3><p><a href="http://click.aliyun.com/m/7689/" target="_blank"><img src="https://img.alicdn.com/tps/TB1c1imOpXXXXacXFXXXXXXXXXX-360-120.jpg"></a></p></div></div></div></article></div></div></section></div><div class="container-fluid global-footer"><div class="row"><div class="container"><div class="row"><div class="col-lg-6 col-xs-6"><div class="footer-logo"></div></div><div class="col-lg-6 col-xs-6 clearfix"><select class="lang-switch pull-right"></select></div><div class="col-lg-12 col-lg-offset-0 col-xs-offset-1 col-xs-10"><span class="footer-text copyright">&copy; 2011-2016 <a href="http://www.alibabagroup.com/en/global/home" target="_blank">Alibaba Group</a>. All rights reserved.</span> <span class="footer-text design-by">Designed by Aliyun UED AX, Proudly powered by <a href="https://github.com/alibaba/tengine" target="_blank">Tengine</a> on <a href="https://www.aliyun.com/" target="_blank">Aliyun</a>.</span></div></div></div></div></div><script src="/js/base.min.js"></script><script src="/js/app.min.js"></script></body></html>