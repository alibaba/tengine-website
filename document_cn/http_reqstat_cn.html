<!DOCTYPE html><html lang="cn" dir="ltr" class="no-js" data-env="dev-env"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta name="renderer" content="webkit"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="author" content="Designed by 阿里云UED AX"><title>ngx_http_reqstat_module - The Tengine Web Server</title><meta name="description" content="描述这个模块计算定义的变量，根据变量值分别统计Tengine的运行状况。可以监视的运行状况有：连接数、请求数、各种响应码范围的请求数、输入输出流量、rt、upstream访问等。可以指定获取所有监控结果或者一部分监控结果。利用变量添加自定义监控状态。总的监控状态最大个数为50个。回收过期的监控数据。设置输出格式跟踪请求，不受内部跳转的影响不要使用与响应相关的变量作为条件，比如&amp;quot;$stat"><meta property="og:type" content="article"><meta property="og:title" content="ngx_http_reqstat_module"><meta property="og:url" content="http://tengine.taobao.org/document_cn/http_reqstat_cn.html"><meta property="og:site_name" content="The Tengine Web Server"><meta property="og:description" content="描述这个模块计算定义的变量，根据变量值分别统计Tengine的运行状况。可以监视的运行状况有：连接数、请求数、各种响应码范围的请求数、输入输出流量、rt、upstream访问等。可以指定获取所有监控结果或者一部分监控结果。利用变量添加自定义监控状态。总的监控状态最大个数为50个。回收过期的监控数据。设置输出格式跟踪请求，不受内部跳转的影响不要使用与响应相关的变量作为条件，比如&amp;quot;$stat"><meta property="og:locale" content="default"><meta property="og:updated_time" content="2018-11-10T11:15:13.937Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="ngx_http_reqstat_module"><meta name="twitter:description" content="描述这个模块计算定义的变量，根据变量值分别统计Tengine的运行状况。可以监视的运行状况有：连接数、请求数、各种响应码范围的请求数、输入输出流量、rt、upstream访问等。可以指定获取所有监控结果或者一部分监控结果。利用变量添加自定义监控状态。总的监控状态最大个数为50个。回收过期的监控数据。设置输出格式跟踪请求，不受内部跳转的影响不要使用与响应相关的变量作为条件，比如&amp;quot;$stat"><link rel="alternate" href="/atom.xml" title="The Tengine Web Server" type="application/atom+xml"><link rel="stylesheet" href="/css/base.min.css"><link rel="stylesheet" href="/css/main.css"></head><body class="page-is-loading"><div class="container-fluid"><div class="row global-header"><div class="container"><div class="row"><div class="col-lg-12"><div class="row"><div class="navbar-header col-lg-2 col-xs-12"><button aria-controls="nav-menu" aria-expanded="false" class="navbar-toggle collapsed" data-target="#nav-menu" data-toggle="collapse" type="button"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button><h1 class="text-muted site-logo navbar-brand"><a href="/" id="logo" class="text-hide">The Tengine Web Server</a></h1></div><div class="col-lg-10 col-xs-12"><nav id="nav-menu" class="navbar-collapse collapse" aria-expanded="false"><ul class="nav navbar-nav navbar-right"><li role="presentation"><a class="menu-item" href="/download.html">Download</a></li><li role="presentation"><a class="menu-item" href="/source.html">Source</a></li><li role="presentation"><a class="menu-item" href="/documentation.html">Document</a></li><li role="presentation"><a class="menu-item" href="/faq.html">FAQ</a></li><li role="presentation"><a class="menu-item" href="/contact.html">Contact</a></li><li role="presentation"><a class="menu-item" href="http://tengine.taobao.org/book/" target="_blank">Guide</a></li><li role="presentation"><a class="menu-item" href="http://click.aliyun.com/m/4339/" target="_blank">Buy Server</a></li><li role="presentation" class="col-hide-xs"><select class="lang-switch pull-right"></select></li><li role="presentation" class="hide"><a href="#"><i class="fa fa-bars" aria-hidden="true"></i></a></li></ul></nav></div></div></div></div></div></div></div><div class="container-fluid" id="main"><section class="row"><div class="fluid-container"><div class="container"><article id="post-document_cn/http_reqstat_cn" class="article article-type-post" itemscope="" itemprop="blogPost"><div class="article-inner"><header class="article-header"><h1 class="article-title" itemprop="name">ngx_http_reqstat_module</h1></header><div class="article-entry" itemprop="articleBody"><h2 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h2><ul><li><p>这个模块计算定义的变量，根据变量值分别统计Tengine的运行状况。</p></li><li><p>可以监视的运行状况有：连接数、请求数、各种响应码范围的请求数、输入输出流量、rt、upstream访问等。</p></li><li><p>可以指定获取所有监控结果或者一部分监控结果。</p></li><li><p>利用变量添加自定义监控状态。总的监控状态最大个数为50个。</p></li><li><p>回收过期的监控数据。</p></li><li><p>设置输出格式</p></li><li><p>跟踪请求，不受内部跳转的影响</p></li><li><p>不要使用与响应相关的变量作为条件，比如&quot;$status&quot;</p></li></ul><h2 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h2><p>默认编入Tengine，可通过--without-http_reqstat_module不编译此模块，或通过--with-http_reqstat_module=shared编译为so模块。</p><p>使用so模块加载的话，请确保其顺序在&quot;ngx_http_lua_module&quot;之后。可以借助&quot;nginx -m&quot;来确认。</p><h2 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http &#123;</span><br><span class="line"></span><br><span class="line">    req_status_zone server &quot;$host,$server_addr:$server_port&quot; 10M;</span><br><span class="line">    req_status_zone_add_indicator server $limit;</span><br><span class="line">    </span><br><span class="line">    server &#123;</span><br><span class="line">        location /us &#123;</span><br><span class="line">            req_status_show;</span><br><span class="line">            req_status_show_field req_total $limit;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        set $limit 0;</span><br><span class="line"></span><br><span class="line">        if ($arg_limit = &apos;1&apos;) &#123;</span><br><span class="line">            set $limit 1;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        req_status server;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>以上例，通过访问/us得到统计结果</li><li>每行对应一个server</li><li>每行的默认格式</li></ul><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">kv,bytes_in,bytes_out,conn_total,req_total,http_2xx,http_3xx,http_4xx,http_5xx,http_other_status,rt,ups_req,ups_rt,ups_tries,http_200,http_206,http_302,http_304,http_403,http_404,http_416,http_499,http_500,http_502,http_503,http_504,http_508,http_other_detail_status,http_ups_4xx,http_ups_5xx</span><br></pre></td></tr></table></figure><ul><li>kv 计算得到的req_status_zone指令定义变量的值，最大长度可配置，默认104B，超长的部分截断</li><li>bytes_in 从客户端接收流量总和</li><li>bytes_out 发送到客户端流量总和</li><li>conn_total 处理过的连接总数</li><li>req_total 处理过的总请求数</li><li>http_2xx 2xx请求的总数</li><li>http_3xx 3xx请求的总数</li><li>http_4xx 4xx请求的总数</li><li>http_5xx 5xx请求的总数</li><li>http_other_status 其他请求的总数</li><li>rt rt的总数</li><li>ups_req 需要访问upstream的请求总数</li><li>ups_rt 访问upstream的总rt</li><li>ups_tries upstram总访问次数</li><li>http_200 200请求的总数</li><li>http_206 206请求的总数</li><li>http_302 302请求的总数</li><li>http_304 304请求的总数</li><li>http_403 403请求的总数</li><li>http_404 404请求的总数</li><li>http_416 416请求的总数</li><li>http_499 499请求的总数</li><li>http_500 500请求的总数</li><li>http_502 502请求的总数</li><li>http_503 503请求的总数</li><li>http_504 504请求的总数</li><li>http_508 508请求的总数</li><li>http_other_detail_status 非以上13种status code的请求总数</li><li>http_ups_4xx upstream返回4xx响应的请求总数</li><li>http_ups_5xx upstream返回5xx响应的请求总数</li><li>可以用&quot;req_status_show_field&quot;指令定义输出格式。左侧栏是字段的名字。</li><li>注，后续会清理这些状态，因为已经支持了自定义状态。</li><li>tsar可解析输出结果，具体见<a href="https://github.com/alibaba/tsar" target="_blank" rel="noopener">https://github.com/alibaba/tsar</a></li></ul><h2 id="指令"><a href="#指令" class="headerlink" title="指令"></a>指令</h2><blockquote><p><strong>Syntax</strong>: _req_status_zone zone_name value size_<br><strong>Default</strong>: <em>none</em><br><strong>Context</strong>: <em>main</em></p></blockquote><p>创建统计使用的共享内存。zone_name是共享内存的名称，value用于定义key，支持变量。size是共享内存的大小。</p><p>例子：</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">req_status_zone server &quot;$host,$server_addr:$server_port&quot; 10M;</span><br></pre></td></tr></table></figure><p>创建名为“server”的共享内存，大小10M，使用“$host,$server_addr:$server_port”计算key。</p><ul><li>注意，如果希望用tsar来监控的话，key的定义中请不要使用逗号。</li></ul><hr><blockquote><p><strong>Syntax</strong>: _req_status zone_name1 [zone_name2 [zone_name3 [...]]]_<br><strong>Default</strong>: <em>none</em><br><strong>Context</strong>: <em>http、srv、loc</em></p></blockquote><p>开启统计，可以指定同时统计多个目标，每一个zone_name对应一个目标。</p><hr><blockquote><p><strong>Syntax</strong>: _req_status_show [zone_name1 [zone_name2 [...]]]_<br><strong>Default</strong>: <em>所有建立的共享内存目标</em><br><strong>Context</strong>: <em>loc</em></p></blockquote><p>按格式返回统计结果。可指定返回部分目标的统计结果。</p><hr><blockquote><p><strong>Syntax</strong>: _req_status_show_field field_name1 [field_name2 [field_name3 [...]]]_<br><strong>Default</strong>: <em>all the fields, including user defined fields</em><br><strong>Context</strong>: <em>loc</em></p></blockquote><p>定义输出格式。可以使用的字段：内置字段，以上面的名字来表示；自定义字段，用变量表示。<br>&#39;kv&#39;总是每行的第一个字段。</p><hr><blockquote><p><strong>Syntax</strong>: _req_status_zone_add_indecator zone_name $var1 [$var2 [...]]_<br><strong>Default</strong>: <em>none</em><br><strong>Context</strong>: <em>http</em></p></blockquote><p>通过变量增加自定义字段，新增加的字段目前会展现在每行的末尾。</p><hr><blockquote><p><strong>Syntax</strong>: _req_status_zone_key_length zone_name length_<br><strong>Default</strong>: <em>none</em><br><strong>Context</strong>: <em>http</em></p></blockquote><p>定义某个共享内存块中key的最大长度，默认值104。key中超出的部分会被截断。</p><hr><blockquote><p><strong>Syntax</strong>: _req_status_zone_recycle zone_name times seconds_<br><strong>Default</strong>: <em>none</em><br><strong>Context</strong>: <em>http</em></p></blockquote><p>定义某个共享内存块过期数据的回收。回收在共享内存耗尽时自动开启。只会回收访问频率低于设置值的监控数据。<br>频率定义为 times / seconds，默认值为10r/min，即</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">req_status_zone_recycle demo_zone 10 60;</span><br></pre></td></tr></table></figure><div class="advertisement"><h3>Advertisement</h3><p><a href="http://click.aliyun.com/m/7689/" target="_blank"><img src="https://img.alicdn.com/tps/TB1c1imOpXXXXacXFXXXXXXXXXX-360-120.jpg"></a></p></div></div></div></article></div></div></section></div><div class="container-fluid global-footer"><div class="row"><div class="container"><div class="row"><div class="col-lg-6 col-xs-6"><div class="footer-logo"></div></div><div class="col-lg-6 col-xs-6 clearfix"><select class="lang-switch pull-right"></select></div><div class="col-lg-12 col-lg-offset-0 col-xs-offset-1 col-xs-10"><span class="footer-text copyright">&copy; 2011-2018 <a href="http://www.alibabagroup.com/en/global/home" target="_blank">Alibaba Group</a>. All rights reserved.</span> <span class="footer-text design-by">Designed by Aliyun UED AX, Proudly powered by <a href="https://github.com/alibaba/tengine" target="_blank">Tengine</a> on <a href="https://www.aliyun.com/" target="_blank">Aliyun</a>.</span></div></div></div></div></div><script src="/js/base.min.js"></script><script src="/js/app.min.js"></script></body></html>