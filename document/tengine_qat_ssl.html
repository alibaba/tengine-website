<!DOCTYPE html><html lang="cn" dir="ltr" class="no-js" data-env="dev-env"><head><meta name="generator" content="Hexo 3.9.0"><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-SNH2MHXGCW"></script><script>window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-SNH2MHXGCW');</script><meta charset="utf-8"><meta name="renderer" content="webkit"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="author" content="Designed by 阿里云UED AX"><title>Introduction - The Tengine Web Server</title><meta name="description" content="This project provides an extended Tengine working with asynchronous mode OpenSSL. With Intel® QuickAssist Technology(QAT) acceleration, the asynchronous mode Tengine can provide significant performanc"><meta property="og:type" content="article"><meta property="og:title" content="Introduction"><meta property="og:url" content="http://tengine.taobao.org/document/tengine_qat_ssl.html"><meta property="og:site_name" content="The Tengine Web Server"><meta property="og:description" content="This project provides an extended Tengine working with asynchronous mode OpenSSL. With Intel® QuickAssist Technology(QAT) acceleration, the asynchronous mode Tengine can provide significant performanc"><meta property="og:locale" content="default"><meta property="og:updated_time" content="2023-11-06T12:30:21.701Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Introduction"><meta name="twitter:description" content="This project provides an extended Tengine working with asynchronous mode OpenSSL. With Intel® QuickAssist Technology(QAT) acceleration, the asynchronous mode Tengine can provide significant performanc"><link rel="alternate" href="/atom.xml" title="The Tengine Web Server" type="application/atom+xml"><link rel="stylesheet" href="/css/base.min.css"><link rel="stylesheet" href="/css/main.css"></head><body class="page-is-loading"><div class="container-fluid"><div class="row global-header"><div class="container"><div class="row"><div class="col-lg-12"><div class="row"><div class="navbar-header col-lg-2 col-xs-12"><button aria-controls="nav-menu" aria-expanded="false" class="navbar-toggle collapsed" data-target="#nav-menu" data-toggle="collapse" type="button"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button><h1 class="text-muted site-logo navbar-brand"><a href="/" id="logo" class="text-hide">The Tengine Web Server</a></h1></div><div class="col-lg-10 col-xs-12"><nav id="nav-menu" class="navbar-collapse collapse" aria-expanded="false"><ul class="nav navbar-nav navbar-right"><li role="presentation"><a class="menu-item" href="/documentation.html">Tengine</a></li><li role="presentation"><a class="menu-item" href="/guide.html">Tengine-Ingress</a></li><li role="presentation"><a class="menu-item" href="/blog.html">Blog</a></li><li role="presentation"><a class="menu-item" href="/download.html">Download</a></li><li role="presentation"><a class="menu-item" href="/source.html">Source</a></li><li role="presentation"><a class="menu-item" href="/contact.html">Contact</a></li><li role="presentation"><a class="menu-item" href="/faq.html">FAQ</a></li><li role="presentation" class="col-hide-xs"><select class="lang-switch pull-right"></select></li><li role="presentation" class="hide"><a href="#"><i class="fa fa-bars" aria-hidden="true"></i></a></li></ul></nav></div></div></div></div></div></div></div><div class="container-fluid" id="main"><section class="row"><div class="fluid-container"><div class="container"><article id="post-document/tengine_qat_ssl" class="article article-type-post" itemscope itemprop="blogPost"><div class="article-inner"><header class="article-header"><h1 class="article-title" itemprop="name">Introduction</h1></header><div class="article-entry" itemprop="articleBody"><p>This project provides an extended Tengine working with asynchronous mode OpenSSL. With Intel® QuickAssist Technology(QAT) acceleration, the asynchronous mode Tengine can provide significant performance improvement.</p><h2 id="Installation-Instructions"><a href="#Installation-Instructions" class="headerlink" title="Installation Instructions"></a>Installation Instructions</h2><h3 id="Setup-building-environment"><a href="#Setup-building-environment" class="headerlink" title="Setup building environment"></a>Setup building environment</h3><p>Set the following environmental variables:</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ICP_ROOT is the directory where QAT driver source code is located</span><br><span class="line">NGINX_INSTALL_DIR is the directory where nginx will be installed to</span><br><span class="line">OPENSSL_LIB is the directory where the openssl has been installed to</span><br></pre></td></tr></table></figure><p>For example:</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ export ICP_ROOT=/QAT/QAT1.6</span><br><span class="line">$ export ICP_BUILD_OUTPUT=$ICP_ROOT/build</span><br><span class="line">$ export OPENSSL_ROOT=/openssl</span><br><span class="line">$ export OPENSSL_LIB=$OPENSSL_ROOT/.openssl</span><br><span class="line">$ export LD_LIBRARY_PATH=$OPENSSL_ROOT/.openssl/lib</span><br><span class="line">$ export OPENSSL_ENGINES=$OPENSSL_LIB/lib/engines-1.1</span><br><span class="line">$ export NGINX_INSTALL_DIR=/tengine-installed/tengine-2.2.2</span><br></pre></td></tr></table></figure><h3 id="Build-OpenSSL"><a href="#Build-OpenSSL" class="headerlink" title="Build OpenSSL"></a>Build OpenSSL</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ cd /</span><br><span class="line">$ git clone --branch OpenSSL_1_1_0f https://github.com/openssl/openssl.git</span><br><span class="line">$ mv OpenSSL_1_1_0f openssl</span><br><span class="line">$ cd openssl</span><br><span class="line">$ mkdir .openssl</span><br><span class="line">$ ./config --prefix=`pwd`/.openssl</span><br><span class="line">$ make</span><br><span class="line">$ make install</span><br></pre></td></tr></table></figure><h3 id="Build-QAT-driver"><a href="#Build-QAT-driver" class="headerlink" title="Build QAT driver"></a>Build QAT driver</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ mkdir /QAT/</span><br><span class="line">$ cd /QAT/</span><br><span class="line">$ wget https://01.org/sites/default/files/page/qatmux.l.2.6.0-60.tgz</span><br><span class="line">$ tar xzvf qatmux.l.2.6.0-60.tgz</span><br><span class="line">$ ./installer.sh (choose 3)</span><br></pre></td></tr></table></figure><h3 id="Build-QAT-engine"><a href="#Build-QAT-engine" class="headerlink" title="Build QAT engine"></a>Build QAT engine</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ cd /</span><br><span class="line">$ git clone --branch v0.5.30 https://github.com/01org/QAT_Engine.git</span><br><span class="line">$ cd /QAT_Engine-0.5.30/qat_contig_mem</span><br><span class="line">$ make</span><br><span class="line">$ make load</span><br><span class="line">$ make test</span><br><span class="line">$ cd /QAT_Engine-0.5.30</span><br><span class="line">$ ./configure \</span><br><span class="line">    --with-qat_dir=$ICP_ROOT \</span><br><span class="line">    --with-openssl_dir=$OPENSSL_ROOT \</span><br><span class="line">    --with-openssl_install_dir=$OPENSSL_LIB </span><br><span class="line">$ make</span><br><span class="line">$ make install</span><br><span class="line"></span><br><span class="line">Note: The kernel version needs to be greater than or equal to 3.1.0.7, need openssl-devel zlib-devel library.</span><br></pre></td></tr></table></figure><p>More details instructions about QAT can be found on QAT engine github <a href="https://github.com/intel/QAT_Engine#installation-instructions" target="_blank" rel="noopener">page</a>.</p><h3 id="Build-Tengine"><a href="#Build-Tengine" class="headerlink" title="Build Tengine"></a>Build Tengine</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ ./configure \</span><br><span class="line">    --prefix=$NGINX_INSTALL_DIR \</span><br><span class="line">    --with-http_ssl_module \</span><br><span class="line">    --with-openssl-async \</span><br><span class="line">    --with-cc-opt=&quot;-DNGX_SECURE_MEM -I$OPENSSL_LIB/include \</span><br><span class="line">    -Wno-error=deprecated-declarations&quot; \</span><br><span class="line">    --with-ld-opt=&quot;-Wl,-rpath=$OPENSSL_LIB/lib -L$OPENSSL_LIB/lib&quot;</span><br><span class="line">$ make</span><br><span class="line">$ make install</span><br></pre></td></tr></table></figure><hr><p>More details instructions about Async Mode Nginx can be found on Intel Async Mode Nginx github <a href="https://github.com/intel/asynch_mode_nginx" target="_blank" rel="noopener">page</a>.</p><h3 id="Configuration"><a href="#Configuration" class="headerlink" title="Configuration"></a>Configuration</h3><p>Tengine configuration<br>Async Mode Tengine provides new directives:</p><hr><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Directives</span><br><span class="line">Syntax:     ssl_async on | off;</span><br><span class="line">Default:    ssl_async off;</span><br><span class="line">Context:    http, server</span><br><span class="line">Enables SSL/TLS asynchronous mode</span><br></pre></td></tr></table></figure><hr><p>For example, edit conf/nginx.conf</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    ……</span><br><span class="line">    server &#123;</span><br><span class="line">        ssl_async  on;</span><br><span class="line">        ……</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="QAT-driver-configuration"><a href="#QAT-driver-configuration" class="headerlink" title="QAT driver configuration"></a>QAT driver configuration</h3><p>The Intel® QAT OpenSSL* Engine comes with some example conf files to use with the Intel® QAT Driver. For Tengine integrated with Intel QAT CLC production, using below commands:</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ cp QAT_Engine/qat/config/dh89xxcc/multi_process_optimized/dh89xxcc_qa_dev0.conf /etc</span><br><span class="line">$ service qat_service restart</span><br></pre></td></tr></table></figure><p>For more details about QAT driver configuration, please refer to QAT engine github <a href="https://github.com/intel/QAT_Engine#using-the-openssl-configuration-file-to-loadinitialize-engines" target="_blank" rel="noopener">page</a></p><h3 id="QAT-engine-enabling-and-configuration"><a href="#QAT-engine-enabling-and-configuration" class="headerlink" title="QAT engine enabling and configuration"></a>QAT engine enabling and configuration</h3><p>QAT engine will be installed as a shared object into OpenSSL installed path and leveraging OpenSSL engine framework to be initialized and configured. Add configuration in $OPENSSL_LIB/ssl/openssl.cnf<br>Note: this configuration should be added on top of the file:</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">openssl_conf = openssl_def</span><br><span class="line">[openssl_def]</span><br><span class="line">engines = engine_section</span><br><span class="line">[engine_section]</span><br><span class="line">qat = qat_section</span><br><span class="line">[qat_section]</span><br><span class="line">engine_id = qat</span><br><span class="line">dynamic_path = /openssl/.openssl/lib/engines-1.1/qat.so</span><br><span class="line">default_algorithms = ALL</span><br></pre></td></tr></table></figure><h2 id="Performance"><a href="#Performance" class="headerlink" title="Performance"></a>Performance</h2><p>Please refer to the White Paper: Intel® Quickassist Technology and OpenSSL-1.1.0:<a href="https://01.org/sites/default/files/downloads/intelr-quickassist-technology/intelquickassisttechnologyopensslperformance.pdf" target="_blank" rel="noopener">Performance</a>.</p><h3 id="Limitations"><a href="#Limitations" class="headerlink" title="Limitations"></a>Limitations</h3><p>Nginx supports reload operation, when QAT hardware is involved for crypto offload, user should enure that there are enough number of qat instances. For example, the available qat instance number should be 2x equal or more than Nginx worker process number.<br>For example, in Nginx configuration file (nginx.conf) worker process number is configured as</p><p>worker_processes 16;</p><p>Then the instance configuration in QAT driver configuration file should be:</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[SHIM]</span><br><span class="line">NumberCyInstances = 1</span><br><span class="line">NumberDcInstances = 0</span><br><span class="line">NumProcesses = 32</span><br><span class="line">LimitDevAccess = 1</span><br></pre></td></tr></table></figure><p>Please refer to details <a href="https://01.org/sites/default/files/page/330751-006_clc_pg.pdf" target="_blank" rel="noopener">QAT develop doc</a>.</p></div></div></article></div></div></section></div><div class="container-fluid global-footer"><div class="row"><div class="container"><div class="row"><div class="col-lg-6 col-xs-6"><div class="footer-logo"></div></div><div class="col-lg-6 col-xs-6 clearfix"><select class="lang-switch pull-right"></select></div><div class="col-lg-12 col-lg-offset-0 col-xs-offset-1 col-xs-10"><span class="footer-text copyright">&copy; 2011-2023 <a href="https://www.alibabagroup.com/" target="_blank">Alibaba Group</a>. All rights reserved.</span> <span class="footer-text design-by">Designed by Aliyun UED AX, Proudly powered by <a href="https://github.com/alibaba/tengine-ingress" target="_blank">Tengine-Ingress</a> on <a href="https://www.aliyun.com/" target="_blank">Aliyun</a>.</span></div></div></div></div></div><script src="/js/base.min.js"></script><script src="/js/app.min.js"></script></body></html>