<!DOCTYPE html><html lang="cn" dir="ltr" class="no-js" data-env="dev-env"><head><meta charset="utf-8"><meta name="renderer" content="webkit"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="author" content="Designed by 阿里云UED AX"><title>consistent hash module - The Tengine Web Server</title><meta name="description" content="DescriptionThis module provides consistent hashing algorithm for upstream load-balancing.If one of backend servers is down, the request of this client will be transferred to another server.server id f"><meta property="og:type" content="article"><meta property="og:title" content="consistent hash module"><meta property="og:url" content="http://tengine.taobao.org/document/http_upstream_consistent_hash.html"><meta property="og:site_name" content="The Tengine Web Server"><meta property="og:description" content="DescriptionThis module provides consistent hashing algorithm for upstream load-balancing.If one of backend servers is down, the request of this client will be transferred to another server.server id f"><meta property="og:updated_time" content="2016-12-03T05:30:54.000Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="consistent hash module"><meta name="twitter:description" content="DescriptionThis module provides consistent hashing algorithm for upstream load-balancing.If one of backend servers is down, the request of this client will be transferred to another server.server id f"><link rel="alternate" href="/atom.xml" title="The Tengine Web Server" type="application/atom+xml"><link rel="stylesheet" href="/css/base.min.css"><link rel="stylesheet" href="/css/main.css"></head><body class="page-is-loading"><div class="container-fluid"><div class="row global-header"><div class="container"><div class="row"><div class="col-lg-12"><div class="row"><div class="navbar-header col-lg-2 col-xs-12"><button aria-controls="nav-menu" aria-expanded="false" class="navbar-toggle collapsed" data-target="#nav-menu" data-toggle="collapse" type="button"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button><h1 class="text-muted site-logo navbar-brand"><a href="/" id="logo" class="text-hide">The Tengine Web Server</a></h1></div><div class="col-lg-10 col-xs-12"><nav id="nav-menu" class="navbar-collapse collapse" aria-expanded="false"><ul class="nav navbar-nav navbar-right"><li role="presentation"><a class="menu-item" href="/download.html">Download</a></li><li role="presentation"><a class="menu-item" href="/source.html">Source</a></li><li role="presentation"><a class="menu-item" href="/documentation.html">Document</a></li><li role="presentation"><a class="menu-item" href="/faq.html">FAQ</a></li><li role="presentation"><a class="menu-item" href="/contact.html">Contact</a></li><li role="presentation"><a class="menu-item" href="http://tengine.taobao.org/book/">Guilde</a></li><li role="presentation" class="col-hide-xs"><select class="lang-switch pull-right"></select></li><li role="presentation" class="hide"><a href="#"><i class="fa fa-bars" aria-hidden="true"></i></a></li></ul></nav></div></div></div></div></div></div></div><div class="container-fluid" id="main"><section class="row"><div class="fluid-container"><div class="container"><article id="post-document/http_upstream_consistent_hash" class="article article-type-post" itemscope itemprop="blogPost"><div class="article-inner"><header class="article-header"><h1 class="article-title" itemprop="name">consistent hash module</h1></header><div class="article-entry" itemprop="articleBody"><h2 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h2><ul><li><p>This module provides consistent hashing algorithm for upstream load-balancing.</p></li><li><p>If one of backend servers is down, the request of this client will be transferred to another server.</p></li><li><p><code>server</code> <em>id</em> field: Id field can be used as server flag. If id field is not set, ip address and port are used to identify server. You can use id field to set server flag mannually. In that case, although ip address or port of a server is changed, id can still identify the server. BTW, it can reduce remapping keys effectively to use id field.</p></li><li><p><code>server</code> <em>weight</em> field: server weight, the number of virtual peers</p></li><li><p>Algorithm: It supposes that 1 server is mapped to m virtual peers, so n servers correspond to n*m virtual peers. All these peers will be mapped to hash ring on average. Every time request comes, it calculates a hash key via configuration parameter, and finds a peer on the hash ring nearest to the location specified by the hash key.</p></li><li><p>It can dispatch requests to backend servers on average according to nginx configuration parameter.</p><ul><li><p><code>consistent_hash $remote_addr</code>: mapping via client ip address</p></li><li><p><code>consistent_hash $request_uri</code>: mapping via request-uri</p></li><li><p><code>consistent_hash $args</code>: mapping via url query string</p></li></ul></li></ul><h2 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h2><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">worker_processes  1;</div><div class="line"></div><div class="line">http &#123;</div><div class="line">    upstream test &#123;</div><div class="line">        consistent_hash $request_uri;</div><div class="line"></div><div class="line">        server 127.0.0.1:9001 id=1001 weight=3;</div><div class="line">        server 127.0.0.1:9002 id=1002 weight=10;</div><div class="line">        server 127.0.0.1:9003 id=1003 weight=20;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="Directives"><a href="#Directives" class="headerlink" title="Directives"></a>Directives</h2><blockquote><p><strong>Syntax</strong>: _consistent_hash variable<em>name</em><br><strong>Default</strong>: <em>none</em><br><strong>Context</strong>: <em>upstream</em></p></blockquote><p>This directive causes requests to be distributed between upstreams based on consistent hashing alogrithm. And it uses nginx variables, specified by variable_name, as input data of hash function.</p><h2 id="Installation"><a href="#Installation" class="headerlink" title="Installation"></a>Installation</h2><ul><li><p>This module is built by default, it can be disabled with the <code>--without-http_upstream_consistent_hash_module</code> configuration parameter.</p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ ./configure</div></pre></td></tr></table></figure></li><li><p>compile</p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ make</div></pre></td></tr></table></figure></li><li><p>install</p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ make install</div></pre></td></tr></table></figure></li></ul></div></div></article></div></div></section></div><div class="container-fluid global-footer"><div class="row"><div class="container"><div class="row"><div class="col-lg-6 col-xs-6"><div class="footer-logo"></div></div><div class="col-lg-6 col-xs-6 clearfix"><select class="lang-switch pull-right"></select></div><div class="col-lg-12 col-lg-offset-0 col-xs-offset-1 col-xs-10"><span class="footer-text copyright">&copy; 2011-2016 Alibaba Inc. All rights reserved.</span> <span class="footer-text design-by">Designed by 阿里云UED AX</span></div></div></div></div></div><script src="/js/base.min.js"></script><script src="/js/app.min.js"></script></body></html>