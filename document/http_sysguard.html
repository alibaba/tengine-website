<!DOCTYPE html><html lang="cn" dir="ltr" class="no-js" data-env="dev-env"><head><meta name="generator" content="Hexo 3.9.0"><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-SNH2MHXGCW"></script><script>window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-SNH2MHXGCW');</script><meta charset="utf-8"><meta name="renderer" content="webkit"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="author" content="Designed by 阿里云UED AX"><title>ngx_http_sysguard_module - The Tengine Web Server</title><meta name="description" content="DescriptionThis module monitors memory usage (including the swap partition), load of CPUs and average response time of requests of the system and cpu usage. If any guideline that is monitored exceeds"><meta property="og:type" content="article"><meta property="og:title" content="ngx_http_sysguard_module"><meta property="og:url" content="http://tengine.taobao.org/document/http_sysguard.html"><meta property="og:site_name" content="The Tengine Web Server"><meta property="og:description" content="DescriptionThis module monitors memory usage (including the swap partition), load of CPUs and average response time of requests of the system and cpu usage. If any guideline that is monitored exceeds"><meta property="og:locale" content="default"><meta property="og:updated_time" content="2023-08-14T09:53:03.332Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="ngx_http_sysguard_module"><meta name="twitter:description" content="DescriptionThis module monitors memory usage (including the swap partition), load of CPUs and average response time of requests of the system and cpu usage. If any guideline that is monitored exceeds"><link rel="alternate" href="/atom.xml" title="The Tengine Web Server" type="application/atom+xml"><link rel="stylesheet" href="/css/base.min.css"><link rel="stylesheet" href="/css/main.css"></head><body class="page-is-loading"><div class="container-fluid"><div class="row global-header"><div class="container"><div class="row"><div class="col-lg-12"><div class="row"><div class="navbar-header col-lg-2 col-xs-12"><button aria-controls="nav-menu" aria-expanded="false" class="navbar-toggle collapsed" data-target="#nav-menu" data-toggle="collapse" type="button"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button><h1 class="text-muted site-logo navbar-brand"><a href="/" id="logo" class="text-hide">The Tengine Web Server</a></h1></div><div class="col-lg-10 col-xs-12"><nav id="nav-menu" class="navbar-collapse collapse" aria-expanded="false"><ul class="nav navbar-nav navbar-right"><li role="presentation"><a class="menu-item" href="/documentation.html">Tengine</a></li><li role="presentation"><a class="menu-item" href="/ingress.html">Ingress</a></li><li role="presentation"><a class="menu-item" href="/guide.html">Guide</a></li><li role="presentation"><a class="menu-item" href="/blog.html">Blog</a></li><li role="presentation"><a class="menu-item" href="/download.html">Download</a></li><li role="presentation"><a class="menu-item" href="/source.html">Source</a></li><li role="presentation"><a class="menu-item" href="/contact.html">Contact</a></li><li role="presentation"><a class="menu-item" href="/faq.html">FAQ</a></li><li role="presentation" class="col-hide-xs"><select class="lang-switch pull-right"></select></li><li role="presentation" class="hide"><a href="#"><i class="fa fa-bars" aria-hidden="true"></i></a></li></ul></nav></div></div></div></div></div></div></div><div class="container-fluid" id="main"><section class="row"><div class="fluid-container"><div class="container"><article id="post-document/http_sysguard" class="article article-type-post" itemscope itemprop="blogPost"><div class="article-inner"><header class="article-header"><h1 class="article-title" itemprop="name">ngx_http_sysguard_module</h1></header><div class="article-entry" itemprop="articleBody"><h2 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h2><p>This module monitors memory usage (including the swap partition), load of CPUs and average response time of requests of the system and cpu usage. If any guideline that is monitored exceeds the threshold set by user, the current request will be redirected to a specific url. To be clarified, this module can only be full functional when the system supports sysinfo function and loadavg function. The sysguard module also need to read memory information from /proc file system.</p><h2 id="Configuration"><a href="#Configuration" class="headerlink" title="Configuration"></a>Configuration</h2><pre><code>server {
    sysguard on;
    sysguard_mode or;

    sysguard_load load=10.5 action=/loadlimit;
    sysguard_mem swapratio=20% action=/swaplimit;
    sysguard_mem free=100M action=/freelimit;
    sysguard_rt rt=0.01 period=5s action=/rtlimit;

    location /loadlimit {
        return 503;
    }

    location /swaplimit {
        return 503;
    }

    location /freelimit {
        return 503;
    }

    location /rtlimit {
        return 503;
    }

    location /cpulimit {
        return 503;
    }
}
</code></pre><h2 id="Directives"><a href="#Directives" class="headerlink" title="Directives"></a>Directives</h2><p><strong>sysguard</strong> <code>on</code> | <code>off</code></p><p><strong>Default:</strong> <code>sysguard off</code></p><p><strong>Context:</strong> <code>http, server, location</code></p><p>Enable or disable the sysguard module.</p><p><br><br><br></p><p><strong>sysguard_load</strong> <code>load=[ncpu*]number [action=/url]</code></p><p><strong>Default:</strong> <code>none</code></p><p><strong>Context:</strong> <code>http, server, location</code></p><p>This directive tells the module to protect the system by monitoring the load of CPUs. If the system&#39;s loads reach the value that is specified by &#39;number&#39; in one minute, the incoming request will be redirected to the url specified by &#39;action&#39; parameter. If &#39;action&#39; is not specified, tengine will respond with 503 error directly. It&#39;s also possible to use ncpu* to make the configuration, in which case, ncpu stands for the number of the CPU cores. For instance, load = ncpu*1.5.</p><p><br><br><br></p><p><strong>sysguard_cpu</strong> <code>usage=num [period=time] [action=/url]</code></p><p><strong>Default:</strong> <code>period=3s</code></p><p><strong>Context:</strong> <code>http, server, location</code></p><p>This directive tells the module to protect the system by monitoring the CPU usage. When the system in the <code>period</code> (<code>units: s</code>) within the CPU reach to num (<code>note:</code> the num is a integer. such as protection CPU is 50% and could be set the usage = 50), the incoming request will be redirected to the url specified by &#39;action&#39; parameter. If the action is not configured, tengine will return 503 directly.</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cpu usage formula：</span><br><span class="line">    cpu_usage = [(cur.usr + cur.nice + cur.sys) - (pre.usr + pre.nice + pre.sys)]/</span><br><span class="line">                [(cur.usr + cur.nice + cur.sys + cur.iowait + cur.irq</span><br><span class="line">                 + cur.softirq + cur.idle)</span><br><span class="line">                 - (pre.usr + pre.nice + pre.sys + pre.iowait + pre.irq</span><br><span class="line">                 + pre.softirq + pre.idle)] * 100</span><br></pre></td></tr></table></figure><p><br><br><br></p><p><strong>sysguard_mem</strong> <code>[swapratio=ratio%] [free=size] [action=/url]</code></p><p><strong>Default:</strong> <code>-</code></p><p><strong>Context:</strong> <code>http, server, location</code></p><p>This directive is used to tell the module to protect the system by monitoring memroy usage. &#39;swapratio&#39; is used to specify how many percent of the swap partition of the system, and &#39;free&#39; is used to specify the miminum size of current memory. If any condition is fulfilled, the incoming request will be redirected to specified url, which is defined by parameter &#39;action&#39;. If &#39;action&#39; is not specified, the request will be responded with 503 error directly. Besides, if the user disables the swap partition in the system, this directive will not be functional. &#39;free&#39; is calculated by /proc/meminfo, the algorithm is &#39;memfree = free + buffered + cached&#39;.</p><p><br><br><br></p><p><strong>sysguard_rt</strong> <code>[rt=seconds] [period=time] [action=/url]</code></p><p><strong>Default:</strong> <code>-</code></p><p><strong>Context:</strong> <code>http, server, location</code></p><p>This directive is used to tell the module to protect the system by monitoring average response time of requests in a specified period. Parameter rt is used to set a threshold of the average response time, in second. Parameter period is used to specifiy the period of the statistics cycle. If the average response time of the system exceeds the threshold specified by the user, the incoming request will be redirected to a specified url which is defined by parameter &#39;action&#39;. If no &#39;action&#39; is presented, the request will be responded with 503 error directly.</p><p><br><br><br></p><p><strong>sysguard_mode</strong> <code>and</code> | <code>or</code></p><p><strong>Default:</strong> <code>sysguard_mode or</code></p><p><strong>Context</strong> <code>http, server, location</code></p><p>If there are more than one type of monitor, this directive is used to specified the relations among all the monitors which are: &#39;and&#39; for all matching and &#39;or&#39; for any matching.</p><p><br><br><br></p><p><strong>sysguard_interval</strong> <code>time</code></p><p><strong>Default</strong> <code>sysguard_interval 1s</code></p><p><strong>Context</strong> <code>http, server, location</code></p><p>Specify the time interval to update your system information.</p><p><br><br><br></p><p><strong>sysguard_log_level</strong> <code>[info | notice | warn | error]</code></p><p><strong>Default</strong> <code>sysguard_log_level error</code></p><p><strong>Context</strong> <code>http, server, location</code></p><p>Specify the log level of sysguard.</p><h2 id="Installation"><a href="#Installation" class="headerlink" title="Installation"></a>Installation</h2><ol><li><p>Compile sysguard module</p><p>configure [--with-http_sysguard_module | --with-http_sysguard_module=shared]</p><p>--with-http_sysguard_module, sysguard module will be compiled statically into tengine.</p><p>--with-http_sysguard_module=shared, sysguard module will be compiled dynamically into tengine.</p></li><li><p>Build and install</p><p>make&amp;make install</p></li><li><p>Make sysguard configuration</p></li><li><p>Run</p></li></ol></div></div></article></div></div></section></div><div class="container-fluid global-footer"><div class="row"><div class="container"><div class="row"><div class="col-lg-6 col-xs-6"><div class="footer-logo"></div></div><div class="col-lg-6 col-xs-6 clearfix"><select class="lang-switch pull-right"></select></div><div class="col-lg-12 col-lg-offset-0 col-xs-offset-1 col-xs-10"><span class="footer-text copyright">&copy; 2011-2023 <a href="https://www.alibabagroup.com/" target="_blank">Alibaba Group</a>. All rights reserved.</span> <span class="footer-text design-by">Designed by Aliyun UED AX, Proudly powered by <a href="https://github.com/alibaba/tengine-ingress" target="_blank">Tengine-Ingress</a> on <a href="https://www.aliyun.com/" target="_blank">Aliyun</a>.</span></div></div></div></div></div><script src="/js/base.min.js"></script><script src="/js/app.min.js"></script></body></html>