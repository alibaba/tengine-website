<!DOCTYPE html><html lang="cn" dir="ltr" class="no-js" data-env="dev-env"><head><meta name="generator" content="Hexo 3.9.0"><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-SNH2MHXGCW"></script><script>window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-SNH2MHXGCW');</script><meta charset="utf-8"><meta name="renderer" content="webkit"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="author" content="Designed by 阿里云UED AX"><title>proxy_connect - The Tengine Web Server</title><meta name="description" content="This module provides support for the CONNECT HTTP method after Tengine version 2.3.0.This method is mainly used to tunnel SSL requests through proxy servers.ExampleConfiguration Exampleserver &amp;#123;"><meta property="og:type" content="article"><meta property="og:title" content="proxy_connect"><meta property="og:url" content="http://tengine.taobao.org/document/proxy_connect.html"><meta property="og:site_name" content="The Tengine Web Server"><meta property="og:description" content="This module provides support for the CONNECT HTTP method after Tengine version 2.3.0.This method is mainly used to tunnel SSL requests through proxy servers.ExampleConfiguration Exampleserver &amp;#123;"><meta property="og:locale" content="default"><meta property="og:updated_time" content="2023-11-06T02:40:24.962Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="proxy_connect"><meta name="twitter:description" content="This module provides support for the CONNECT HTTP method after Tengine version 2.3.0.This method is mainly used to tunnel SSL requests through proxy servers.ExampleConfiguration Exampleserver &amp;#123;"><link rel="alternate" href="/atom.xml" title="The Tengine Web Server" type="application/atom+xml"><link rel="stylesheet" href="/css/base.min.css"><link rel="stylesheet" href="/css/main.css"></head><body class="page-is-loading"><div class="container-fluid"><div class="row global-header"><div class="container"><div class="row"><div class="col-lg-12"><div class="row"><div class="navbar-header col-lg-2 col-xs-12"><button aria-controls="nav-menu" aria-expanded="false" class="navbar-toggle collapsed" data-target="#nav-menu" data-toggle="collapse" type="button"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button><h1 class="text-muted site-logo navbar-brand"><a href="/" id="logo" class="text-hide">The Tengine Web Server</a></h1></div><div class="col-lg-10 col-xs-12"><nav id="nav-menu" class="navbar-collapse collapse" aria-expanded="false"><ul class="nav navbar-nav navbar-right"><li role="presentation"><a class="menu-item" href="/documentation.html">Tengine</a></li><li role="presentation"><a class="menu-item" href="/ingress.html">Ingress</a></li><li role="presentation"><a class="menu-item" href="/guide.html">Guide</a></li><li role="presentation"><a class="menu-item" href="/blog.html">Blog</a></li><li role="presentation"><a class="menu-item" href="/download.html">Download</a></li><li role="presentation"><a class="menu-item" href="/source.html">Source</a></li><li role="presentation"><a class="menu-item" href="/contact.html">Contact</a></li><li role="presentation"><a class="menu-item" href="/faq.html">FAQ</a></li><li role="presentation" class="col-hide-xs"><select class="lang-switch pull-right"></select></li><li role="presentation" class="hide"><a href="#"><i class="fa fa-bars" aria-hidden="true"></i></a></li></ul></nav></div></div></div></div></div></div></div><div class="container-fluid" id="main"><section class="row"><div class="fluid-container"><div class="container"><article id="post-document/proxy_connect" class="article article-type-post" itemscope itemprop="blogPost"><div class="article-inner"><header class="article-header"><h1 class="article-title" itemprop="name">proxy_connect</h1></header><div class="article-entry" itemprop="articleBody"><p>This module provides support for the CONNECT HTTP method after Tengine version 2.3.0.<br>This method is mainly used to <a href="https://en.wikipedia.org/wiki/HTTP_tunnel#HTTP_CONNECT_tunneling" target="_blank" rel="noopener">tunnel SSL requests</a> through proxy servers.</p><h1 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h1><h2 id="Configuration-Example"><a href="#Configuration-Example" class="headerlink" title="Configuration Example"></a>Configuration Example</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen                         3128;</span><br><span class="line"></span><br><span class="line">    # dns resolver used by forward proxying</span><br><span class="line">    resolver                       8.8.8.8;</span><br><span class="line"></span><br><span class="line">    # forward proxy for CONNECT request</span><br><span class="line">    proxy_connect;</span><br><span class="line">    proxy_connect_allow            443 563;</span><br><span class="line">    proxy_connect_connect_timeout  10s;</span><br><span class="line">    proxy_connect_read_timeout     10s;</span><br><span class="line">    proxy_connect_send_timeout     10s;</span><br><span class="line"></span><br><span class="line">    # forward proxy for non-CONNECT request</span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://$host;</span><br><span class="line">        proxy_set_header Host $host;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Example-for-curl"><a href="#Example-for-curl" class="headerlink" title="Example for curl"></a>Example for curl</h2><p>With above configuration, you can get any https website via HTTP CONNECT tunnel.<br>A simple test with command <code>curl</code> is as following:</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ curl https://github.com/ -v -x 127.0.0.1:3128</span><br><span class="line">*   Trying 127.0.0.1...                                           -.</span><br><span class="line">* Connected to 127.0.0.1 (127.0.0.1) port 3128 (#0)                | curl creates TCP connection with nginx (with proxy_connect module).</span><br><span class="line">* Establish HTTP proxy tunnel to github.com:443                   -&apos;</span><br><span class="line">&gt; CONNECT github.com:443 HTTP/1.1                                 -.</span><br><span class="line">&gt; Host: github.com:443                                         (1) | curl sends CONNECT request to create tunnel.</span><br><span class="line">&gt; User-Agent: curl/7.43.0                                          |</span><br><span class="line">&gt; Proxy-Connection: Keep-Alive                                    -&apos;</span><br><span class="line">&gt;</span><br><span class="line">&lt; HTTP/1.0 200 Connection Established                             .- nginx replies 200 that tunnel is established.</span><br><span class="line">&lt; Proxy-agent: nginx                                           (2)|  (The client is now being proxied to the remote host. Any data sent</span><br><span class="line">&lt;                                                                 &apos;-  to nginx is now forwarded, unmodified, to the remote host)</span><br><span class="line"></span><br><span class="line">* Proxy replied OK to CONNECT request</span><br><span class="line">* TLS 1.2 connection using TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256  -.</span><br><span class="line">* Server certificate: github.com                                   |</span><br><span class="line">* Server certificate: DigiCert SHA2 Extended Validation Server CA  | curl sends &quot;https://github.com&quot; request via tunnel,</span><br><span class="line">* Server certificate: DigiCert High Assurance EV Root CA           | proxy_connect module will proxy data to remote host (github.com).</span><br><span class="line">&gt; GET / HTTP/1.1                                                   |</span><br><span class="line">&gt; Host: github.com                                             (3) |</span><br><span class="line">&gt; User-Agent: curl/7.43.0                                          |</span><br><span class="line">&gt; Accept: */*                                                     -&apos;</span><br><span class="line">&gt;</span><br><span class="line">&lt; HTTP/1.1 200 OK                                                 .-</span><br><span class="line">&lt; Date: Fri, 11 Aug 2017 04:13:57 GMT                             |</span><br><span class="line">&lt; Content-Type: text/html; charset=utf-8                          |  Any data received from remote host will be sent to client</span><br><span class="line">&lt; Transfer-Encoding: chunked                                      |  by proxy_connect module.</span><br><span class="line">&lt; Server: GitHub.com                                           (4)|</span><br><span class="line">&lt; Status: 200 OK                                                  |</span><br><span class="line">&lt; Cache-Control: no-cache                                         |</span><br><span class="line">&lt; Vary: X-PJAX                                                    |</span><br><span class="line">...                                                               |</span><br><span class="line">... &lt;other response headers &amp; response body&gt; ...                  |</span><br><span class="line">...                                                               &apos;-</span><br></pre></td></tr></table></figure><p>The sequence diagram of above example is as following:</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">  curl                     nginx (proxy_connect)            github.com</span><br><span class="line">    |                             |                          |</span><br><span class="line">(1) |-- CONNECT github.com:443 --&gt;|                          |</span><br><span class="line">    |                             |                          |</span><br><span class="line">    |                             |----[ TCP connection ]---&gt;|</span><br><span class="line">    |                             |                          |</span><br><span class="line">(2) |&lt;- HTTP/1.1 200           ---|                          |</span><br><span class="line">    |   Connection Established    |                          |</span><br><span class="line">    |                             |                          |</span><br><span class="line">    |                                                        |</span><br><span class="line">    ========= CONNECT tunnel has been establesied. ===========</span><br><span class="line">    |                                                        |</span><br><span class="line">    |                             |                          |</span><br><span class="line">    |                             |                          |</span><br><span class="line">    |   [ SSL stream       ]      |                          |</span><br><span class="line">(3) |---[ GET / HTTP/1.1   ]-----&gt;|   [ SSL stream       ]   |</span><br><span class="line">    |   [ Host: github.com ]      |---[ GET / HTTP/1.1   ]--&gt;.</span><br><span class="line">    |                             |   [ Host: github.com ]   |</span><br><span class="line">    |                             |                          |</span><br><span class="line">    |                             |                          |</span><br><span class="line">    |                             |                          |</span><br><span class="line">    |                             |   [ SSL stream       ]   |</span><br><span class="line">    |   [ SSL stream       ]      |&lt;--[ HTTP/1.1 200 OK  ]---&apos;</span><br><span class="line">(4) |&lt;--[ HTTP/1.1 200 OK  ]------|   [ &lt; html page &gt;    ]   |</span><br><span class="line">    |   [ &lt; html page &gt;    ]      |                          |</span><br><span class="line">    |                             |                          |</span><br></pre></td></tr></table></figure><h1 id="Install"><a href="#Install" class="headerlink" title="Install"></a>Install</h1><ul><li>Build Tengine with this module from source:</li></ul><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ ./configure --add-module=./modules/ngx_http_proxy_connect_module</span><br><span class="line">$ make &amp;&amp; make install</span><br></pre></td></tr></table></figure><h1 id="Directive"><a href="#Directive" class="headerlink" title="Directive"></a>Directive</h1><h2 id="proxy-connect"><a href="#proxy-connect" class="headerlink" title="proxy_connect"></a>proxy_connect</h2><p>Syntax: <strong>proxy_connect</strong><br>Default: <code>none</code><br>Context: <code>server</code></p><p>Enable &quot;CONNECT&quot; HTTP method support.</p><h2 id="proxy-connect-allow"><a href="#proxy-connect-allow" class="headerlink" title="proxy_connect_allow"></a>proxy_connect_allow</h2><p>Syntax: <strong>proxy_connect_allow <code>all | [port ...] | [port-range ...]</code></strong><br>Default: <code>443 563</code><br>Context: <code>server</code></p><p>This directive specifies a list of port numbers or ranges to which the proxy CONNECT method may connect.<br>By default, only the default https port (443) and the default snews port (563) are enabled.<br>Using this directive will override this default and allow connections to the listed ports only.</p><p>The value <code>all</code> will allow all ports to proxy.</p><p>The value <code>port</code> will allow specified port to proxy.</p><p>The value <code>port-range</code> will allow specified range of port to proxy, for example:</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">proxy_connect_allow 1000-2000 3000-4000; # allow range of port from 1000 to 2000, from 3000 to 4000.</span><br></pre></td></tr></table></figure><h2 id="proxy-connect-connect-timeout"><a href="#proxy-connect-connect-timeout" class="headerlink" title="proxy_connect_connect_timeout"></a>proxy_connect_connect_timeout</h2><p>Syntax: <strong>proxy_connect_connect_timeout <code>time</code></strong><br>Default: <code>none</code><br>Context: <code>server</code></p><p>Defines a timeout for establishing a connection with a proxied server.</p><h2 id="proxy-connect-read-timeout"><a href="#proxy-connect-read-timeout" class="headerlink" title="proxy_connect_read_timeout"></a>proxy_connect_read_timeout</h2><p>Syntax: <strong>proxy_connect_read_timeout <code>time</code></strong><br>Default: <code>60s</code><br>Context: <code>server</code></p><p>Defines a timeout for reading a response from the proxied server.<br>The timeout is set only between two successive read operations, not for the transmission of the whole response.<br>If the proxied server does not transmit anything within this time, the connection is closed.</p><h2 id="proxy-connect-send-timeout"><a href="#proxy-connect-send-timeout" class="headerlink" title="proxy_connect_send_timeout"></a>proxy_connect_send_timeout</h2><p>Syntax: <strong>proxy_connect_send_timeout <code>time</code></strong><br>Default: <code>60s</code><br>Context: <code>server</code></p><p>Sets a timeout for transmitting a request to the proxied server.<br>The timeout is set only between two successive write operations, not for the transmission of the whole request.<br>If the proxied server does not receive anything within this time, the connection is closed.</p><h2 id="proxy-connect-address"><a href="#proxy-connect-address" class="headerlink" title="proxy_connect_address"></a>proxy_connect_address</h2><p>Syntax: <strong>proxy_connect_address <code>address | off</code></strong><br>Default: <code>none</code><br>Context: <code>server</code></p><p>Specifiy an IP address of the proxied server. The address can contain variables.<br>The special value off is equal to none, which uses the IP address resolved from host name of CONNECT request line.</p><h2 id="proxy-connect-bind"><a href="#proxy-connect-bind" class="headerlink" title="proxy_connect_bind"></a>proxy_connect_bind</h2><p>Syntax: <strong>proxy_connect_bind <code>address [transparent] | off</code></strong><br>Default: <code>none</code><br>Context: <code>server</code></p><p>Makes outgoing connections to a proxied server originate from the specified local IP address with an optional port.<br>Parameter value can contain variables. The special value off is equal to none, which allows the system to auto-assign the local IP address and port.</p><p>The transparent parameter allows outgoing connections to a proxied server originate from a non-local IP address, for example, from a real IP address of a client:</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">proxy_connect_bind $remote_addr transparent;</span><br></pre></td></tr></table></figure><p>In order for this parameter to work, it is usually necessary to run nginx worker processes with the <a href="http://nginx.org/en/docs/ngx_core_module.html#user" target="_blank" rel="noopener">superuser</a> privileges. On Linux it is not required (1.13.8) as if the transparent parameter is specified, worker processes inherit the CAP_NET_RAW capability from the master process. It is also necessary to configure kernel routing table to intercept network traffic from the proxied server.</p><h1 id="Variables"><a href="#Variables" class="headerlink" title="Variables"></a>Variables</h1><h2 id="connect-host"><a href="#connect-host" class="headerlink" title="$connect_host"></a>$connect_host</h2><p>host name from CONNECT request line.</p><h2 id="connect-port"><a href="#connect-port" class="headerlink" title="$connect_port"></a>$connect_port</h2><p>port from CONNECT request line.</p><h2 id="connect-addr"><a href="#connect-addr" class="headerlink" title="$connect_addr"></a>$connect_addr</h2><p>IP address and port of the remote host, e.g. &quot;192.168.1.5:12345&quot;.<br>IP address is resolved from host name of CONNECT request line.</p><h2 id="proxy-connect-connect-timeout-1"><a href="#proxy-connect-connect-timeout-1" class="headerlink" title="$proxy_connect_connect_timeout"></a>$proxy_connect_connect_timeout</h2><p>Get or set timeout of <a href="#proxy_connect_connect_timeout"><code>proxy_connect_connect_timeout</code> directive</a>.</p><p>For example:</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># Set default value</span><br><span class="line"></span><br><span class="line">proxy_connect_connect_timeout   10s;</span><br><span class="line">proxy_connect_read_timeout      10s;</span><br><span class="line">proxy_connect_send_timeout      10s;</span><br><span class="line"></span><br><span class="line"># Overlap default value</span><br><span class="line"></span><br><span class="line">if ($host = &quot;test.com&quot;) &#123;</span><br><span class="line">    set $proxy_connect_connect_timeout  &quot;10ms&quot;;</span><br><span class="line">    set $proxy_connect_read_timeout     &quot;10ms&quot;;</span><br><span class="line">    set $proxy_connect_send_timeout     &quot;10ms&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="proxy-connect-read-timeout-1"><a href="#proxy-connect-read-timeout-1" class="headerlink" title="$proxy_connect_read_timeout"></a>$proxy_connect_read_timeout</h2><p>Get or set a timeout of <a href="#proxy_connect_read_timeout"><code>proxy_connect_read_timeout</code> directive</a>.</p><h2 id="proxy-connect-send-timeout-1"><a href="#proxy-connect-send-timeout-1" class="headerlink" title="$proxy_connect_send_timeout"></a>$proxy_connect_send_timeout</h2><p>Get or set a timeout of <a href="#proxy_connect_send_timeout"><code>proxy_connect_send_timeout</code> directive</a>.</p><h1 id="Known-Issues"><a href="#Known-Issues" class="headerlink" title="Known Issues"></a>Known Issues</h1><ul><li>In HTTP/2, the CONNECT method is not supported. It only supports the CONNECT method request in HTTP/1.x and HTTPS.</li></ul></div></div></article></div></div></section></div><div class="container-fluid global-footer"><div class="row"><div class="container"><div class="row"><div class="col-lg-6 col-xs-6"><div class="footer-logo"></div></div><div class="col-lg-6 col-xs-6 clearfix"><select class="lang-switch pull-right"></select></div><div class="col-lg-12 col-lg-offset-0 col-xs-offset-1 col-xs-10"><span class="footer-text copyright">&copy; 2011-2023 <a href="https://www.alibabagroup.com/" target="_blank">Alibaba Group</a>. All rights reserved.</span> <span class="footer-text design-by">Designed by Aliyun UED AX, Proudly powered by <a href="https://github.com/alibaba/tengine-ingress" target="_blank">Tengine-Ingress</a> on <a href="https://www.aliyun.com/" target="_blank">Aliyun</a>.</span></div></div></div></div></div><script src="/js/base.min.js"></script><script src="/js/app.min.js"></script></body></html>