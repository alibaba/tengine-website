<!DOCTYPE html><html lang="cn" dir="ltr" class="no-js" data-env="dev-env"><head><meta name="generator" content="Hexo 3.9.0"><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-SNH2MHXGCW"></script><script>window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-SNH2MHXGCW');</script><meta charset="utf-8"><meta name="renderer" content="webkit"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="author" content="Designed by 阿里云UED AX"><title>ngx_http_reqstat_module - The Tengine Web Server</title><meta name="description" content="DescriptionThis module will help monitor running status of Tengine.It can provide running status information of Tengine.The information is divided into different zones, and each zone is independent.Th"><meta property="og:type" content="article"><meta property="og:title" content="ngx_http_reqstat_module"><meta property="og:url" content="http://tengine.taobao.org/document/http_reqstat.html"><meta property="og:site_name" content="The Tengine Web Server"><meta property="og:description" content="DescriptionThis module will help monitor running status of Tengine.It can provide running status information of Tengine.The information is divided into different zones, and each zone is independent.Th"><meta property="og:locale" content="default"><meta property="og:updated_time" content="2023-07-21T06:56:49.741Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="ngx_http_reqstat_module"><meta name="twitter:description" content="DescriptionThis module will help monitor running status of Tengine.It can provide running status information of Tengine.The information is divided into different zones, and each zone is independent.Th"><link rel="alternate" href="/atom.xml" title="The Tengine Web Server" type="application/atom+xml"><link rel="stylesheet" href="/css/base.min.css"><link rel="stylesheet" href="/css/main.css"></head><body class="page-is-loading"><div class="container-fluid"><div class="row global-header"><div class="container"><div class="row"><div class="col-lg-12"><div class="row"><div class="navbar-header col-lg-2 col-xs-12"><button aria-controls="nav-menu" aria-expanded="false" class="navbar-toggle collapsed" data-target="#nav-menu" data-toggle="collapse" type="button"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button><h1 class="text-muted site-logo navbar-brand"><a href="/" id="logo" class="text-hide">The Tengine Web Server</a></h1></div><div class="col-lg-10 col-xs-12"><nav id="nav-menu" class="navbar-collapse collapse" aria-expanded="false"><ul class="nav navbar-nav navbar-right"><li role="presentation"><a class="menu-item" href="/documentation.html">Tengine</a></li><li role="presentation"><a class="menu-item" href="/ingress.html">Ingress</a></li><li role="presentation"><a class="menu-item" href="/guide.html">Guide</a></li><li role="presentation"><a class="menu-item" href="/blog.html">Blog</a></li><li role="presentation"><a class="menu-item" href="/download.html">Download</a></li><li role="presentation"><a class="menu-item" href="/source.html">Source</a></li><li role="presentation"><a class="menu-item" href="/contact.html">Contact</a></li><li role="presentation"><a class="menu-item" href="/faq.html">FAQ</a></li><li role="presentation" class="col-hide-xs"><select class="lang-switch pull-right"></select></li><li role="presentation" class="hide"><a href="#"><i class="fa fa-bars" aria-hidden="true"></i></a></li></ul></nav></div></div></div></div></div></div></div><div class="container-fluid" id="main"><section class="row"><div class="fluid-container"><div class="container"><article id="post-document/http_reqstat" class="article article-type-post" itemscope itemprop="blogPost"><div class="article-inner"><header class="article-header"><h1 class="article-title" itemprop="name">ngx_http_reqstat_module</h1></header><div class="article-entry" itemprop="articleBody"><h2 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h2><p>This module will help monitor running status of Tengine.</p><ul><li><p>It can provide running status information of Tengine.</p></li><li><p>The information is divided into different zones, and each zone is independent.</p></li><li><p>The status information is about connections, requests, response status codes, input and output flows,<br>rt, upstreams, and so on.</p></li><li><p>It shows all the results by default, and can be set to show part of them by specifying zones.</p></li><li><p>It supports for user-defined status by using nginx variables. The maximum of all the status is 50.</p></li><li><p>It recycles out-of-date running status information.</p></li><li><p>It supports for defining output format.</p></li><li><p>It follows the request processing flow, so internal redirect will not affect monitoring.</p></li><li><p>Do not use variables of response as a condition, eg., $status.</p></li></ul><h2 id="Compilation"><a href="#Compilation" class="headerlink" title="Compilation"></a>Compilation</h2><p>The module is compiled into Tengine by default. It can be disabled with &#39;--without-http_reqstat_module&#39;<br>configuration parameter, or it can be compiled as a &#39;.so&#39; with &#39;--with-http_reqstat_module=shared&#39;.</p><p>If you use this module as a &#39;.so&#39;, please make sure it is after &#39;ngx_http_lua_module&#39;. Please refer to<br>&#39;nginx -m&#39;.</p><h2 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http &#123;</span><br><span class="line"></span><br><span class="line">    req_status_zone server &quot;$host,$server_addr:$server_port&quot; 10M;</span><br><span class="line">    req_status_zone_add_indicator server $limit;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        location /us &#123;</span><br><span class="line">            req_status_show;</span><br><span class="line">            req_status_show_field req_total $limit;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        set $limit 0;</span><br><span class="line"></span><br><span class="line">        if ($arg_limit = &apos;1&apos;) &#123;</span><br><span class="line">            set $limit 1;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        req_status server;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>when you call &#39;/us&#39;, you will get the results like this:</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">www.example.com,127.0.0.1:80,162,6242,1,1,1,0,0,0,0,10,1,10,1....</span><br></pre></td></tr></table></figure><ul><li>Each line shows the status infomation of a &quot;$host,$server_addr:$server_port&quot;.</li><li><p>Default line format:</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">kv,bytes_in,bytes_out,conn_total,req_total,http_2xx,http_3xx,http_4xx,http_5xx,http_other_status,rt,ups_req,ups_rt,ups_tries,http_200,http_206,http_302,http_304,http_403,http_404,http_416,http_499,http_500,http_502,http_503,http_504,http_508,http_other_detail_status,http_ups_4xx,http_ups_5xx</span><br></pre></td></tr></table></figure><ul><li><strong>kv</strong> value of the variable defined by the directive &#39;req_status_zone&#39;. The maximun key length is configurable, 152B by default, and overlength will be cut off</li><li><strong>bytes_in</strong> total number of bytes received from client</li><li><strong>bytes_out</strong> total number of bytes sent to client</li><li><strong>conn_total</strong> total number of accepted connections</li><li><strong>req_total</strong> total number of processed requests</li><li><strong>http_2xx</strong> total number of 2xx requests</li><li><strong>http_3xx</strong> total number of 3xx requests</li><li><strong>http_4xx</strong> total number of 4xx requests</li><li><strong>http_5xx</strong> total number of 5xx requests</li><li><strong>http_other_status</strong> total number of other requests</li><li><strong>rt</strong> accumulation or rt</li><li><strong>ups_req</strong> total number of requests calling for upstream</li><li><strong>ups_rt</strong> accumulation or upstream rt</li><li><strong>ups_tries</strong> total number of times calling for upstream</li><li><strong>http_200</strong> total number of 200 requests</li><li><strong>http_206</strong> total number of 206 requests</li><li><strong>http_302</strong> total number of 302 requests</li><li><strong>http_304</strong> total number of 304 requests</li><li><strong>http_403</strong> total number of 403 requests</li><li><strong>http_404</strong> total number of 404 requests</li><li><strong>http_416</strong> total number of 416 requests</li><li><strong>http_499</strong> total number of 499 requests</li><li><strong>http_500</strong> total number of 500 requests</li><li><strong>http_502</strong> total number of 502 requests</li><li><strong>http_503</strong> total number of 503 requests</li><li><strong>http_504</strong> total number of 504 requests</li><li><strong>http_508</strong> total number of 508 requests</li><li><strong>http_other_detail_status</strong> total number of requests of other status codes* <strong>http_ups_4xx</strong> total number of requests of upstream 4xx</li><li><strong>http_ups_5xx</strong> total number of requests of upstream 5xx</li></ul></li><li>You can use names in the left column to define output format, with directive &#39;req_status_show_field&#39;</li><li>Some fields will be removed in future, because user-defined status has been supported.</li></ul></li><li>tsar can parse the result and monitor, see also <a href="https://github.com/alibaba/tsar" target="_blank" rel="noopener">https://github.com/alibaba/tsar</a></li></ul><h2 id="Directives"><a href="#Directives" class="headerlink" title="Directives"></a>Directives</h2><hr><blockquote><p><strong>Syntax</strong>: _req_status_zone zone_name value size_<br><strong>Default</strong>: <em>none</em><br><strong>Context</strong>: <em>http</em></p></blockquote><p>create shared memory for this module. &#39;zone_name&#39; is the name of memory block.<br>&#39;value&#39; defines the key, in which variables can be used.<br>&#39;size&#39; defines the size of shared memory.</p><p>Example:</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">req_status_zone server &quot;$host,$server_addr:$server_port&quot; 10M;</span><br></pre></td></tr></table></figure><p>the memory is 10MB, the key is &quot;$host,$server_addr:$server_port&quot;, and the name is &quot;server&quot;.</p><ul><li>Notice, if you want to use tsar to monitor, you should not use comma in the key.</li></ul><hr><blockquote><p><strong>Syntax</strong>: _req_status zone_name1 [zone_name2 [zone_name3 [...]]]_<br><strong>Default</strong>: <em>none</em><br><strong>Context</strong>: <em>http、srv、loc</em></p></blockquote><p>Enable monitoring. You can specify multiple zones to monitor.</p><hr><blockquote><p><strong>Syntax</strong>: _req_status_show [zone_name1 [zone_name2 [...]]]_<br><strong>Default</strong>: _all the targets defined by &#39;req_status_zone&#39;_<br><strong>Context</strong>: <em>loc</em></p></blockquote><p>Display the status information. You can specify zones to display.</p><hr><blockquote><p><strong>Syntax</strong>: _req_status_show_field field_name1 [field_name2 [field_name3 [...]]]_&gt;<br><strong>Default</strong>: <em>all the fields, including user defined fields</em>&gt;<br><strong>Context</strong>: <em>loc</em></p></blockquote><p>Define output format, used with the directive &#39;req_status_show&#39;. You can use names<br>to define internal supported fields, see it above. And also you can use variables<br>to define user defined fields. &#39;kv&#39; is always the first field in a line.</p><hr><blockquote><p><strong>Syntax</strong>: _req_status_zone_add_indecator zone_name $var1 [$var2 [...]]_<br><strong>Default</strong>: <em>none</em><br><strong>Context</strong>: <em>http</em></p></blockquote><p>Add user-defined status by using nginx variables. The status will be appended at the end of each line on display.</p><hr><blockquote><p><strong>Syntax</strong>: _req_status_zone_key_length zone_name length_<br><strong>Default</strong>: <em>none</em><br><strong>Context</strong>: <em>http</em></p></blockquote><p>Define the maximun length of key for a zone. The default is 104.</p><hr><blockquote><p><strong>Syntax</strong>: _req_status_zone_recycle zone_name times seconds_<br><strong>Default</strong>: <em>none</em><br><strong>Context</strong>: <em>http</em></p></blockquote><p>Define the recycle threshold for a zone. Recycle will be switched on when the shared memory is exhausted,<br>and will only take effect on imformation whose visit frequency is lower than the setting.<br>The setting frequency is defined by &#39;times&#39; and &#39;seconds&#39;, and it is 10r/min by default.</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">req_status_zone_recycle demo_zone 10 60;</span><br></pre></td></tr></table></figure><hr><p><strong>Syntax</strong>: <em>req_status_lazy on|off</em></p><p><strong>Default</strong>: <em>off</em></p><p><strong>Context</strong>: <em>http、srv、loc</em></p><p>req_status_lazy directive is used to control whether the variable in the req_status_zone directive is recalculate during the log phasei. In order to solve some variables (such as the upstream_xxx related variable) as a key scene to get empty value.</p></div></div></article></div></div></section></div><div class="container-fluid global-footer"><div class="row"><div class="container"><div class="row"><div class="col-lg-6 col-xs-6"><div class="footer-logo"></div></div><div class="col-lg-6 col-xs-6 clearfix"><select class="lang-switch pull-right"></select></div><div class="col-lg-12 col-lg-offset-0 col-xs-offset-1 col-xs-10"><span class="footer-text copyright">&copy; 2011-2023 <a href="https://www.alibabagroup.com/" target="_blank">Alibaba Group</a>. All rights reserved.</span> <span class="footer-text design-by">Designed by Aliyun UED AX, Proudly powered by <a href="https://github.com/alibaba/tengine-ingress" target="_blank">Tengine-Ingress</a> on <a href="https://www.aliyun.com/" target="_blank">Aliyun</a>.</span></div></div></div></div></div><script src="/js/base.min.js"></script><script src="/js/app.min.js"></script></body></html>