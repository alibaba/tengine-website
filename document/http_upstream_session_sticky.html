<!DOCTYPE html><html lang="cn" dir="ltr" class="no-js" data-env="dev-env"><head><meta name="generator" content="Hexo 3.9.0"><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-SNH2MHXGCW"></script><script>window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-SNH2MHXGCW');</script><meta charset="utf-8"><meta name="renderer" content="webkit"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="author" content="Designed by 阿里云UED AX"><title>ngx_http_upstream_session_sticky_module - The Tengine Web Server</title><meta name="description" content="This module is a load balancing module. It sticks the session between client and backend server via cookie. In such case, it guarantees that requests from the same client are distributed to the same s"><meta property="og:type" content="article"><meta property="og:title" content="ngx_http_upstream_session_sticky_module"><meta property="og:url" content="http://tengine.taobao.org/document/http_upstream_session_sticky.html"><meta property="og:site_name" content="The Tengine Web Server"><meta property="og:description" content="This module is a load balancing module. It sticks the session between client and backend server via cookie. In such case, it guarantees that requests from the same client are distributed to the same s"><meta property="og:locale" content="default"><meta property="og:updated_time" content="2023-11-07T10:08:07.689Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="ngx_http_upstream_session_sticky_module"><meta name="twitter:description" content="This module is a load balancing module. It sticks the session between client and backend server via cookie. In such case, it guarantees that requests from the same client are distributed to the same s"><link rel="alternate" href="/atom.xml" title="The Tengine Web Server" type="application/atom+xml"><link rel="stylesheet" href="/css/base.min.css"><link rel="stylesheet" href="/css/main.css"></head><body class="page-is-loading"><div class="container-fluid"><div class="row global-header"><div class="container"><div class="row"><div class="col-lg-12"><div class="row"><div class="navbar-header col-lg-2 col-xs-12"><button aria-controls="nav-menu" aria-expanded="false" class="navbar-toggle collapsed" data-target="#nav-menu" data-toggle="collapse" type="button"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button><h1 class="text-muted site-logo navbar-brand"><a href="/" id="logo" class="text-hide">The Tengine Web Server</a></h1></div><div class="col-lg-10 col-xs-12"><nav id="nav-menu" class="navbar-collapse collapse" aria-expanded="false"><ul class="nav navbar-nav navbar-right"><li role="presentation"><a class="menu-item" href="/documentation.html">Tengine</a></li><li role="presentation"><a class="menu-item" href="/guide.html">Tengine-Ingress</a></li><li role="presentation"><a class="menu-item" href="/blog.html">Blog</a></li><li role="presentation"><a class="menu-item" href="/download.html">Download</a></li><li role="presentation"><a class="menu-item" href="/source.html">Source</a></li><li role="presentation"><a class="menu-item" href="/contact.html">Contact</a></li><li role="presentation"><a class="menu-item" href="/faq.html">FAQ</a></li><li role="presentation" class="col-hide-xs"><select class="lang-switch pull-right"></select></li><li role="presentation" class="hide"><a href="#"><i class="fa fa-bars" aria-hidden="true"></i></a></li></ul></nav></div></div></div></div></div></div></div><div class="container-fluid" id="main"><section class="row"><div class="fluid-container"><div class="container"><article id="post-document/http_upstream_session_sticky" class="article article-type-post" itemscope itemprop="blogPost"><div class="article-inner"><header class="article-header"><h1 class="article-title" itemprop="name">ngx_http_upstream_session_sticky_module</h1></header><div class="article-entry" itemprop="articleBody"><p>This module is a load balancing module. It sticks the session between client and backend server via cookie. In such case, it guarantees that requests from the same client are distributed to the same server.</p><h2 id="Example-1"><a href="#Example-1" class="headerlink" title="Example 1"></a>Example 1</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># default: cookie=route mode=insert fallback=on</span><br><span class="line">upstream foo &#123;</span><br><span class="line">    server 192.168.0.1;</span><br><span class="line">    server 192.168.0.2;</span><br><span class="line">    session_sticky;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://foo;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Example-2"><a href="#Example-2" class="headerlink" title="Example 2"></a>Example 2</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># insert + indirect mode:</span><br><span class="line">upstream test &#123;</span><br><span class="line">    session_sticky session_sticky cookie=uid domain=www.xxx.com fallback=on path=/ mode=insert option=indirect;</span><br><span class="line">    server  127.0.0.1:8080;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    location / &#123;</span><br><span class="line">        # You need configure session_sticky_hide_cookie in insert + indirect mode or prefix mode.</span><br><span class="line">        # It removes the cookie before sending to backend server, and the backend server will not</span><br><span class="line">        # receive and process this extra cookie.</span><br><span class="line">        session_sticky_hide_cookie upstream=test;</span><br><span class="line">        proxy_pass http://test;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Directive"><a href="#Directive" class="headerlink" title="Directive"></a>Directive</h2><blockquote><p>Syntax: <strong>session_sticky</strong> <code>[cookie=name] [domain=your_domain] [path=your_path ] [maxage=time] [mode=insert|rewrite|prefix] [option=indirect] [maxidle=time] [&gt; maxlife=time] [fallback=on|off] [hash=plain|md5]</code><br>Default: <code>session_sticky cookie=route mode=insert fallback=on</code><br>Context: <code>upstream</code></p></blockquote><p>Description:</p><p>This directive will turn on the session sticky module. Specific parameters are as follows:</p><ul><li><code>cookie</code> sets name of session cookie.</li><li><code>domain</code> sets domain of cookie. It is not set by default.</li><li><code>path</code> sets url path of cookie. The default value is &#39;/&#39;.</li><li><code>maxage</code> set lifetime of cookie (cookie max-age attribute). If not set, it&#39;s a session cookie. It expires when the browser is closed.</li><li><p><code>mode</code> sets mode of cookie:</p></li><li><p><strong>insert</strong>: This mode inserts cookie into http response via Set-Cookie header.</p></li><li><strong>prefix</strong>: This mode doesn&#39;t generate new cookie, but it inserts specific prefix ahead of cookie value of http response (e.g. &quot;Cookie: NAME=SRV~VALUE&quot;). When client(browser) requests next time with this specific cookie, it will delete inserted prefix before passing request to backend server. The operation is transparent to backend server which will get origin cookie .</li><li><strong>rewrite</strong>: In this mode, backend server can set cookie of session sticky itself. If backend server doesn&#39;t set this cookie in response, it disables session sticky for this request. In this mode, backend server manages which request needs sesstion sticky.</li><li><p><code>option</code> sets option value(indirect and direct) for cookie of session sticky. If setting indirect, it hides cookie of session sticky from backend server, otherwise the opposite.</p></li><li><p><code>maxidle</code> sets max idle time of session.</p></li><li><code>maxlife</code> sets max lifetime of session.</li><li><code>fallback</code> sets whether it can retry others when current backend server is down.</li><li><code>hash</code> sets whether server flag in cookie is passed through plaintext or md5. By default, md5 is used.</li></ul><blockquote></blockquote><blockquote><p>Syntax: <strong>session_sticky_hide_cookie</strong> upstream=name;<br>Default: none<br>Context: server, location</p></blockquote><p>Description:</p><p>This directive works with proxy_pass directive. It deletes cookie used as session sticky in insert+indirect and prefix mode, in which case cookie will be hidden from backend server. Upstream name specifies which upstream this directive takes effect in.</p></div></div></article></div></div></section></div><div class="container-fluid global-footer"><div class="row"><div class="container"><div class="row"><div class="col-lg-6 col-xs-6"><div class="footer-logo"></div></div><div class="col-lg-6 col-xs-6 clearfix"><select class="lang-switch pull-right"></select></div><div class="col-lg-12 col-lg-offset-0 col-xs-offset-1 col-xs-10"><span class="footer-text copyright">&copy; 2011-2023 <a href="https://www.alibabagroup.com/" target="_blank">Alibaba Group</a>. All rights reserved.</span> <span class="footer-text design-by">Designed by Aliyun UED AX, Proudly powered by <a href="https://github.com/alibaba/tengine-ingress" target="_blank">Tengine-Ingress</a> on <a href="https://www.aliyun.com/" target="_blank">Aliyun</a>.</span></div></div></div></div></div><script src="/js/base.min.js"></script><script src="/js/app.min.js"></script></body></html>